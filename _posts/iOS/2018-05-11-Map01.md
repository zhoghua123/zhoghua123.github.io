---
layout: post
title: 地图系列之一CoreLocation
category: iOS开发
tags: Map
description: Map
---

# 简介
1. 在移动互联网时代，移动app能解决用户的很多生活琐事，比如
    1. 周边：找餐馆、找KTV、找电影院等等
    2. 导航：根据用户设定的起点和终点，进行路线规划，并指引用户如何到达
2. 在上述应用中，都用到了**定位**和**地图**功能，在iOS开发中，要想加入这2大功能，必须基于2个框架进行开发
    1. CoreLocation ：用于地理定位，地理编码，区域监听等（着重功能实现）
    2. MapKit ：用于地图展示，例如大头针，路线、覆盖层展示等（着重界面展示）
    3. 说明: 这两个框架MapKit相对来说更加重量级,MapKit定位是相对于CoreLocation来做的,因此要先研究CoreLocation
3. 2个热门专业术语
    1. LBS ：Location Based Service(基于定位的服务)
    2. SoLoMo ：Social Local Mobile（索罗门）

# CoreLocation框架的使用
1. CoreLocation框架使用前提
    1. 导入框架（Xcode5.0之后可以省略）
    2. 导入主头文件`#import <CoreLocation/CoreLocation.h>` 
2. CoreLocation框架使用须知
    1. CoreLocation框架中所有数据类型的前缀都是CL
    2. CoreLocation中使用CLLocationManager对象来做用户定位
    
## 用户隐私的保护
1. iOS<8.0
    1. 从iOS 6开始，苹果在保护用户隐私方面做了很大的加强，以下操作都必须经过用户批准授权
        1. 要想获得用户的位置/想访问用户的通讯录、日历、相机、相册等等
        2. 当想访问用户的隐私信息时，系统会自动弹出一个对话框让用户授权
        3. 一旦用户选择了“Don’t Allow”，意味着你的应用以后就无法使用定位功能
    2. 开发者可以在Info.plist中设置`NSLocationUsageDescription`说明定位的目的(`Privacy - Location Usage Description`)
    3. 前台定位
        1. 创建位置管理者 CLLocationManager并设置代理
            
            ```
            // 创建定位服务管理者
            CLLocationManager *localManager = [[CLLocationManager alloc] init];
            //设置地理
            localManager.delegate = self;
            ```
        2. 开始定位,调用方法,更新位置信息
            
            ```
            //开始定位用户位置
            [localManager startUpdatingLocation];
            ```
        3. 在CLLocationManagerDelegate的代理方法中获取用户位置信息
        
            ````
            /*
             只要定位的用户位置就会调用(调用频率特别高)
             */
            - (void)locationManager:(CLLocationManager *)manager
                 didUpdateLocations:(NSArray<CLLocation *> *)locations{
            }
            ````
    4. 后台定位
        1. 条件:
            1. 在前台基础上,勾选后台模式location updates或者直接info.plist文件,添加Required background modes(两者实现同一个操作)
        1. 操作:(**两者二选一**)
            1. Capabilities -> Background Models -> 选中Location updates 打钩
            2. info.plist操作:
                
                ```
                添加Required background modes(数组类型)->
                App registers for location updates
                ```
2. iOS>=8.0 && iOS<9.0
    1. 前台定位
        1. 创建位置管理者CLLocationManager,并设置代理(略)
        2. 开始定位,调用方法(略)
        3. 在CLLocationManagerDelegate的代理方法中获取用户位置信息(略)
        4. iOS8.0后增加操作:
            1. 主动请求前台定位授权
                
                ```
                [localManager requestWhenInUseAuthorization];
                ```
            2. 在info.plist中填写对应的key(一定要填key)
                
                ```
                NSLocationWhenInUseUsageDescription 需要您的同意,才能访问您的位置
                ```
    2. 后台定位
        1. 需要在前台定位基础上,即先将上面4步做完
        2. 两种方案: 
            1. 方案一: 
                1. 开启后台模式 Location updates
                    1. Capabilities -> Background Models -> 选中Location updates 打钩
                2. 特点: 
                    1. 当在后台获取到用户的位置时,会在顶部显示一个蓝条,提醒用户这个app在不断的获取你的位置信息
                    2. 当用户点击了这个蓝条,会打开对应的app
            2. 方案二:
                1. 开启前后台定位授权
                    
                    ```
                    [localManager requestAlwaysAuthorization];
                    ```
                2. 在info.plist中填写对应的key(一定要填key)
                    
                    ```
                    NSLocationAlwaysUsageDescription 需要您的同意,才能访问您的位置
                    ```
3. iOS>+9.0 iOS<11.0
    1. 前台定位
        1. 相对于iOS8.0 前台定位一样,没有变化(略)
    2. 后台定位
        1. 需要在前台定位基础上,即先将上面4步做完
        2. 两种方案
            1. 方案一: 
                1. 开启后台模式 Location updates
                    1. Capabilities -> Background Models -> 选中Location updates 打钩
                2. iOS9.0后增加操作
                        
                    ```
                    localManager.allowsBackgroundLocationUpdates = YES;
                    ```            
                2. 特点: 
                    1. 当在后台获取到用户的位置时,会在顶部显示一个蓝条,提醒用户这个app在不断的获取你的位置信息
                    2. 当用户点击了这个蓝条,会打开对应的app
            2. 方案二:(与iOS8.0一样)
4. iOS>= 11.0
    1. 在之前的基础上在info.plist中增加一个字段即可
        
        ```
        NSLocationAlwaysAndWhenInUseUsageDescription  需要您的同意,才能访问您的位置
        ```

## CLLocationManager
1. CLLocationManager的常用操作
    
    ```
    开始更新用户位置
    - (void)startUpdatingLocation;
    
    //获取地理位置,只获取一次(iOS>9.0)
    - (void)requestLocation;
    
    停止更新用户位置
    - (void) stopUpdatingLocation;
    
    当调用了startUpdatingLocation方法后，就开始不断地请求、刷新用户的位置，一旦请求到用户位置就会调用代理的下面方法
    - (void)locationManager:(CLLocationManager *)manager didUpdateLocations:(NSArray *)locations;
    locations参数里面装着CLLocation对象
    
    为了严谨起见，最好在使用定位功能之前判断当前应用的定位功能是否可用
    CLLocationManager有个类方法可以判断当前应用的定位功能是否可用
      + (BOOL)locationServicesEnabled;

    ```
2. 常见属性
    
    ```
    每隔多少米定位一次
    @property(assign, nonatomic) CLLocationDistance distanceFilter;
    
    定位精确度（越精确就越耗电）
    @property(assign, nonatomic) CLLocationAccuracy desiredAccuracy;
    
    CLLocationAccuracy常用常量: 
 kCLLocationAccuracyBestForNavigation
         //最适合导航
 kCLLocationAccuracyBest
         //最好的
 kCLLocationAccuracyNearestTenMeters
         //10m
 kCLLocationAccuracyHundredMeters
         //100m
 kCLLocationAccuracyKilometer
         //1000m
 kCLLocationAccuracyThreeKilometers
         //3000m
    ```
3. 常用代理方法
    
    ```
    /*
     只要定位的用户位置就会调用(调用频率特别高)
     locations: 数组里面是CLLocation对象
     */
    - (void)locationManager:(CLLocationManager *)manager
         didUpdateLocations:(NSArray<CLLocation *> *)locations{
        NSLog(@"--------%@",locations);
        //1. 获取位置对象
        CLLocation *location = locations.firstObject;
        //2. 取出经纬度
        CLLocationCoordinate2D coordinate = location.coordinate;
        NSLog(@"纬度为:%f--经度为:-%f",coordinate.latitude,coordinate.longitude);
        
        // 停止定位(省电措施：只要不想用定位服务，就马上停止定位服务)
        [manager stopUpdatingLocation];
    }
    //检查用户授权的状态
    /*
     CLAuthorizationStatus枚举如下:
     kCLAuthorizationStatusNotDetermined 用户还未决定
     
     kCLAuthorizationStatusRestricted 访问受限
     
     kCLAuthorizationStatusDenied 用户拒绝
     
     kCLAuthorizationStatusAuthorizedAlways 获得了前后台定位授权
     
     kCLAuthorizationStatusAuthorizedWhenInUse 获得了前台定位授权
    
     */
    -(void)locationManager:(CLLocationManager *)manager didChangeAuthorizationStatus:(CLAuthorizationStatus)status{
    }
    ```

### CLLocation
1. CLLocation用来表示某个位置的地理信息，比如经纬度、海拔等等
2. 常用属性
    
    ```
    经纬度
    @property(readonly, nonatomic) CLLocationCoordinate2D coordinate;
    
    CLLocationCoordinate2D类型是一个结构体:
    struct CLLocationCoordinate2D {
     CLLocationDegrees latitude;//纬度
     CLLocationDegrees longitude;//经度
     };
    
    海拔
    @property(readonly, nonatomic) CLLocationDistance altitude;
    
    路线，航向（取值范围是0.0° ~ 359.9°，0.0°代表真北方向）
    @property(readonly, nonatomic) CLLocationDirection course;
    
    移动速度（单位是m/s）
    @property(readonly, nonatomic) CLLocationSpeed speed;
    
    用- (CLLocationDistance)distanceFromLocation:(const CLLocation *)location方法可以计算2个位置之间的距离
    ```
    

