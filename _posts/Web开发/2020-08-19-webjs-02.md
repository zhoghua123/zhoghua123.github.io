---
layout: post
title: Ajax
category: Web开发
tags: Web开发
description: Web开发
--- 

## Ajax

### 基本概念
1. 如何让电脑提供管理网站的服务?
    1. 安装Web服务相关软件, 例如: Apache、IIS、Tomcat、Nginx、NodeJS等；
    2. 安装Web服务相关软件, 例如: Apache、IIS、Tomcat、Nginx、NodeJS等；
    3. Web服务器软件：Apache、IIS、Tomcat、Nginx、NodeJS等；
2. Web服务器搭建
    1. 什么是WAMPServer软件?(该软件可以具备以下功能)
        1. Windows操作系统
        2. Apache 世界排名第一的服务器软件,特点是简单,速度快,性能稳定
        3. MySQL 开源免费的数据库软件，特点是体积小、速度快、使用成本低
        4. PHP 超文本预处理器,直接将代码嵌入HTML文档中执行, 特点是简单易学,容易上手
    2. 如何搭建Apache服务器?
        1. 安装WAMPServer软件即可
        2. 一直下一步，然后选择桌面上的谷歌浏览器快捷方式，选择两次。
    3. 测试是否安装好
        1. 运行wampserver
        2. 浏览器输入：`127.0.0.1`查看显示的内容
3. 如何运行编写好的PHP文件?
    1. 因为PHP是服务端编程语言, 所以要在服务端运行,就是必须有服务器环境
    2. php文件名称不能有中文
    3. php文件**必须放到服务器文件夹下**
        1. 找到WAMPServer安装路径的文件夹`D:\wamp64\wamp64\www`
        2. 在该路径下新建一个文件：`jQuery`
        3. 浏览器输入`127.0.0.1`打开，对应的就是`www`这个文件夹
        4. 在jQuery文件夹下编写php代码，比如`PHP-BASE.php`
        5. 然后浏览器输入`127.0.0.1/jQuery/PHP-BASE.php`，就可以看到编写的内容
    4. 通过ip找到服务器文件夹, 选中php文件访问
4. 总结：
    1. 后端编写的代码不能直接运行，只能放到服务器对应的文件夹下，通过服务器运行
    2. 如何通过服务器运行：通过Ip地址找到服务器对应的文件夹，然后找到对应的文件运行

### Ajax简介
1. 什么是Ajax?
    1. `AJAX = Asynchronous JavaScript and XML`（异步的 JavaScript 和 XML）。
    2. AJAX 不是新的编程语言，而是一种使用现有标准的新方法。
    3. AJAX 是与服务器交换数据并更新部分网页的艺术，在不重新加载整个页面的情况下。

### Ajax编程基础

#### Ajax基础
1. 传统网站中存在的问题
    1. 网速慢的情况下，页面加载时间长，用户只能等待
    2. 表单提交后，如果一项内容不合格，需要重新填写所有表单内容
    3. 页面跳转，重新加载页面，造成资源浪费，增加用户等待时间
2. Ajax 概述
    1. Ajax：标准读音 `[ˈeɪˌdʒæks]` ，中文音译：阿贾克斯
    2. 它是浏览器提供的一套方法，可以实现页面无刷新更新数据，提高用户浏览网站应用的体验。
3. Ajax 的运行环境
    1. Ajax 技术需要**运行在网站环境中才能生效**，当前课程会使用Node创建的服务器作为网站服务器。
    2. 即直接双击打开html文件，Ajax代码是不会生效的

#### Ajax 运行原理及实现
1. Ajax 运行原理
    1. Ajax 相当于浏览器发送请求与接收响应的代理人，以实现在不影响用户浏览页面的情况下，局部更新页面数据，从而提高用户体验。
2. Ajax 的实现步骤
    
    ```
    //1.创建 Ajax 对象
    var xhr = new XMLHttpRequest();
    //2. 告诉 Ajax 请求地址以及请求方式
    xhr.open('get', 'http://www.example.com');
    //发送请求
    xhr.send();
    //3. 获取服务器端给与客户端的响应数据
    xhr.onload = function () { 
        console.log(xhr.responseText);
    }
    ```
    
#### 服务器端响应的数据格式
1. 真实的项目中，**服务器端大多数情况下会以 JSON 对象作为响应数据的格式**。当客户端拿到响应数据时，要将 JSON 数据和 HTML 字符串进行拼接，然后将拼接的结果展示在页面中。
2. 在 http 请求与响应的过程中，无论是请求参数还是响应内容，如果是对象类型，最终都会被转换为对象字符串进行传输。
    1. 服务端返回json字符串，然后我们将json串转化为json对象
    
    ```
    JSON.parse() // 将 json 字符串转换为json对象
    ```
3. 举例：
    
    ```
    // 4.获取服务器端响应到客户端的数据
		xhr.onload = function (){
			// console.log(typeof xhr.responseText)
			// 将JSON字符串转换为JSON对象
			var responseText = JSON.parse(xhr.responseText);
			// 测试：在控制台输出处理结果
			console.log(responseText)
			// 将数据和html字符串进行拼接
			var str = '<h2>'+ responseText.name +'</h2>';
			// 将拼接的结果追加到页面中
			document.body.innerHTML = str;
		}
    ```

#### 请求参数传递
1. 传统网站表单提交
    
    ```
    <form method="get" action="http://www.example.com">
        <input type="text" name="username"/>
        <input type="password" name="password">
    </form>
    <!– http://www.example.com?username=zhangsan&password=123456 -->
    ```
2. GET 请求方式
    
    ```
    xhr.open('get', 'http://www.example.com?name=zhangsan&age=20');
    ```
3. POST 请求方式
    
    ```
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
    xhr.send('name=zhangsan&age=20');
    ```
4. 代码举例：
    
    ```
    <input type="text" id="username"><br>
    <input type="text" id="age"><br>
    <input type="button" value="提交" id="btn"><br>
    
    <script type="text/javascript">
    	// 获取按钮元素
    	var btn = document.getElementById('btn');
    	// 获取姓名文本框
    	var username = document.getElementById('username');
    	// 获取年龄文本框
    	var age = document.getElementById('age');
    	// 为按钮添加点击事件
    	btn.onclick = function () {
    		// 创建ajax对象
    		var xhr = new XMLHttpRequest();
    		// 获取用户在文本框中输入的值
    		var nameValue = username.value;
    		var ageValue = age.value;
    		// 拼接请求参数
    		var params = 'username='+ nameValue +'&age=' + ageValue;
    		
    		/*****get请求*******/
    		// 配置ajax对象
    		xhr.open('get', 'http://localhost:3000/get?'+params);
    		// 发送请求
    		xhr.send();
    		
    		/*****post请求*******/
    		// 配置ajax对象
			xhr.open('post', 'http://localhost:3000/post');
			// 设置请求参数格式的类型（post请求必须要设置）
			xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
			// 发送请求
			xhr.send(params);
    		
    		// 获取服务器端响应的数据
    		xhr.onload = function () {
    			console.log(xhr.responseText)
    		}
    	}
    </script>
    ```
    
##### 浏览器调试Ajax网络调用
1. F12打开代码调试
2. 点击Network
3. 点击XHR,专门用于调试Ajax网络请求
    
#### 请求报文
1. 在 HTTP 请求和响应的过程中传递的数据块就叫**报文**，包括要传送的数据和一些附加信息，这些数据和信息要遵守规定好的格式。

#### 请求参数的格式
1. `application/x-www-form-urlencoded`
    
    ```
    name=zhangsan&age=20&sex=男
    ```
2. `application/json`
    
    ```
    {name: 'zhangsan', age: '20', sex: '男'}
    ```
    
    1. 在请求头中指定 `Content-Type` 属性的值是 `application/json`，告诉服务器端当前请求参数的格式是 `json`。
    2. 还需要将json对象转化为json字符串，然后传递给服务器
    
        ```
        JSON.stringify() // 将json对象转换为json字符串
        ```
3. **注意:**get 请求是不能提交 json 对象数据格式的，传统网站的表单提交也是不支持 json 对象数据格式的。
4. 代码举例：
    
    ```
    // 1.创建ajax对象
    var xhr = new XMLHttpRequest();
    // 2.告诉Ajax对象要向哪发送请求，以什么方式发送请求
    // 1)请求方式 2)请求地址
    xhr.open('post', 'http://localhost:3000/json');
    // 通过请求头告诉服务器端客户端向服务器端传递的请求参数的格式是什么
    xhr.setRequestHeader('Content-Type', 'application/json');
    // JSON.stringify() 将json对象转换为json字符串
    // 3.发送请求
    //将json对象转化为json对象，才能传递参数
    xhr.send(JSON.stringify({name: 'lisi', age:50}));
    // 4.获取服务器端响应到客户端的数据
    xhr.onload = function (){
    	console.log(xhr.responseText)
    }
    ```

#### 获取服务器端的响应
1. Ajax 状态码
    1. 在创建ajax对象，配置ajax对象，发送请求，以及接收完服务器端响应数据，这个过程中的每一个步骤都会对应一个数值， 这个数值就是ajax状态码。
        1. 0:请求未初始化(还没有调用open())
        2. 1:请求已经建立，但是还没有发送(还没有调用send())
        3. 2:请求已经发送
        4. 3:请求正在处理中，通常响应中已经有部分数据可以用了
        5. 4:响应已经完成，可以获取并使用服务器的响应了
        
        ```
        xhr.readyState // 获取Ajax状态码
        ```
2. `onreadystatechange 事件`
    1. 当 Ajax 状态码发生变化时将自动触发该事件。
    2. 在事件处理函数中可以获取 Ajax 状态码并对其进行判断，当状态码为 4 时就可以通过 xhr.responseText 获取服务器端的响应数据了。
        
        ```
        // 当Ajax状态码发生变化时调用
        xhr.onreadystatechange = function () {
            // 判断当Ajax状态码为4时 
            if (xhr.readyState == 4) {
                // 获取服务器端的响应数据 
                console.log(xhr.responseText);
            }
        }
        ```
3. **两种获取服务器端响应方式的区别**
    
    ```
    区别                      onload事件            onreadystatechange事件
    是否兼容IE低版本            不兼容                 兼容
    是否需要判断Ajax状态码       不需要                 需要
    被调用次数                  一次                  多次
    ```
   
#### 低版本 IE 浏览器的缓存问题
1. 问题：在低版本的 IE 浏览器中，Ajax 请求有严重的缓存问题，即在请求地址不发生变化的情况下，只有第一次请 求会真正发送到服务器端，后续的请求都会从浏览器的缓存中获取结果。即使服务器端的数据更新了，客户端依然 拿到的是缓存中的旧数据。
2. 解决方案：在请求地址的后面加请求参数，保证每一次请求中的请求参数的值不相同。
    
    ```
    xhr.open('get', 'http://www.example.com?t=' + Math.random());
    ```

#### Ajax封装

```
function ajax (options) {
	// 存储的是默认值
	var defaults = {
		type: 'get',
		url: '',
		data: {},
		header: {
			'Content-Type': 'application/x-www-form-urlencoded'
		},
		success: function () {},
		error: function () {}
	};

	// 使用options对象中的属性覆盖defaults对象中的属性
	Object.assign(defaults, options);

	// 创建ajax对象
	var xhr = new XMLHttpRequest();
	// 拼接请求参数的变量
	var params = '';
	// 循环用户传递进来的对象格式参数
	for (var attr in defaults.data) {
		// 将参数转换为字符串格式
		params += attr + '=' + defaults.data[attr] + '&';
	}
	// 将参数最后面的&截取掉 
	// 将截取的结果重新赋值给params变量
	params = params.substr(0, params.length - 1);

	// 判断请求方式
	if (defaults.type == 'get') {
		defaults.url = defaults.url + '?' + params;
	}
	// 配置ajax对象
	xhr.open(defaults.type, defaults.url);
	// 如果请求方式为post
	if (defaults.type == 'post') {
		// 用户希望的向服务器端传递的请求参数的类型
		var contentType = defaults.header['Content-Type']
		// 设置请求参数格式的类型
		xhr.setRequestHeader('Content-Type', contentType);
		// 判断用户希望的请求参数格式的类型
		// 如果类型为json
		if (contentType == 'application/json') {
			// 向服务器端传递json数据格式的参数
			xhr.send(JSON.stringify(defaults.data))
		}else {
			// 向服务器端传递普通类型的请求参数
			xhr.send(params);
		}

	}else {
		// 发送请求
		xhr.send();
	}
	// 监听xhr对象下面的onload事件
	// 当xhr对象接收完响应数据后触发
	xhr.onload = function () {

		// xhr.getResponseHeader()
		// 获取响应头中的数据
		var contentType = xhr.getResponseHeader('Content-Type');
		// 服务器端返回的数据
		var responseText = xhr.responseText;

		// 如果响应类型中包含applicaition/json
        //includes判断字符串中是否包含某个字符串
		if (contentType.includes('application/json')) {
			// 将json字符串转换为json对象
			responseText = JSON.parse(responseText)
		}

		// 当http状态码等于200的时候
		if (xhr.status == 200) {
			// 请求成功 调用处理成功情况的函数
			defaults.success(responseText, xhr);
		}else {
			// 请求失败 调用处理失败情况的函数
			defaults.error(responseText, xhr);
		}
	}
}

//函数调用
ajax({
	type: 'post',
	// 请求地址
	url: 'http://localhost:3000/responseData',
    data:{
        name:'zhangsan',
        age:20
    },
    header: {
        'Content-Type': 'application/json'
    },
	success: function (data) {
		console.log('这里是success函数');
		console.log(data)
	}
})
```

### Ajax 扩展编程

#### 模板引擎
1. 模板引擎概述
    1. 客户端给服务端发送请求，服务端将数据和HTML拼接好，将拼接好的html字符串返回给客户端。
    2. 使用ajax给服务端发送请求，服务端将返回json格式的数据，数据和html的拼接将在客户端来完成
    3. 客户端进行数据拼接时就需要模板引擎
2. 模板引擎的作用：
    1. 将数据和HTML拼接起来
    2. 即使用模板引擎提供的模板语法，可以将数据和 HTML 拼接起来。
3. 官方地址： [https://aui.github.io/art-template/zh-cn/index.html](https://aui.github.io/art-template/zh-cn/index.html)
4. 使用步骤
    1. 下载 `art-template` 模板引擎库文件并在 HTML 页面中引入库文件
        1. 打开官网->点击Docs->点击安装->在浏览器中实时编译(下载：`template-web.js`)
        2. 右击"连接存储为"得到`template-web.js`文件
        
        ```
        <script src="./js/template-web.js"></script>
        ```
    2. 准备 `art-template` 模板
        
        ```
        <script id="tpl" type="text/html">
            <div class="box"></div>
        </script>
        ```
    3. 告诉模板引擎将哪一个模板和哪个数据进行拼接
        
        ```
        var html = template('tpl', {username: 'zhangsan', age: '20'});
        ```
    4. 将拼接好的html字符串添加到页面中
        
        ```
        document.getElementById('container').innerHTML = html;
        ```
    5. 通过模板语法告诉模板引擎，数据和html字符串要如何拼接
        
        ```
        <script id="tpl" type="text/html">
            <div class="box"> {{ username }} </div>
        </script>
        ```
5. 代码举例：
    
    ```
    <!DOCTYPE html>
    <html lang="en">
    <head>
    	<meta charset="UTF-8">
    	<title>Document</title>
    	<!-- 1. 将模板引擎的库文件引入到当前页面 -->
    	<script src="/js/template-web.js"></script>
    </head>
    <body>
    	<div id="container"></div>
    	<!-- 2.准备art-template模板 -->
    	<script type="text/html" id="tpl">
    		<h1>{{username}} {{age}}</h1>
    	</script>
    	<script type="text/javascript">
    		// 3.告诉模板引擎将那个数据和哪个模板进行拼接
    		// 1) 模板id 2)数据 对象类型
    		// 方法的返回值就是拼接好的html字符串
    		var html = template('tpl', {username: 'zhangsan', age: 30});
            //4. 将绑定数据后的模板（html标签）显示给相应的标签
    		document.getElementById('container').innerHTML = html;
    	</script>
    </body>
    </html>
    ```
    
#### FormData
1. FormData 对象的作用
    1. 模拟HTML表单，相当于将HTML表单映射成表单对象，自动将表单对象中的数据拼接成请求参数的格式。
    2. 异步上传二进制文件
2. FormData 对象的使用
    1. 准备 HTML 表单
        
        ```
        <form id="form">
            <input type="text" name="username" />
            <input type="password" name="password" />
            <input type="button"/>
        </form>
        ```
    2. 将 HTML 表单转化为 formData 对象
        
        ```
        var form = document.getElementById('form');
        var formData = new FormData(form);
        ```
    3. 提交表单对象
        
        ```
        xhr.send(formData);
        ```

### jQuery 中的 Ajax
1. `$.ajax()`方法概述
    1. 作用:发送Ajax请求。
    
    ```
    $.ajax({
    type: 'get',
    url: 'http://www.example.com',
    data: { name: 'zhangsan', age: '20' }, 
    contentType: 'application/x-www-form-urlencoded', 
    beforeSend: function () {
        return false
    },
    success: function (response) {}, 
    error: function (xhr) {}
    });
    ```
  

