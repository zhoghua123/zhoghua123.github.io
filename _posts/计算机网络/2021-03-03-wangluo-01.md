---
layout: post
title: 网络协议八：HTTPS
category: 计算机网络
tags: 计算机网络
description: 计算机网络
---

## HTTPS
1. 简介
    1. HTTPS（HyperText Transfer Protocol Secure），译为：超文本传输安全协议
        1. 常称为HTTP over TLS、HTTP over SSL、HTTP Secure
        2. 由网景公司于1994年首次提出
    2. HTTPS的默认端口号是443（HTTP是80）
    3. 现在在浏览器上输入http://www.baidu.com,会自动重定向到https://www.baidu.com

### SSL/TLS
1. HTTPS是在HTTP的基础上使用SSL/TLS来加密报文，对窃听和中间人攻击提供合理的防护
2. SSL/TLS也可以用在其他协议上，比如
    1. FTP → FTPS
    2. SMTP → SMTPS
3. TLS（Transport Layer Security），译为：传输层安全性协议
    1. 前身是SSL（Secure Sockets Layer），译为：安全套接层
4. 历史版本信息
    1. SSL 1.0：因存在严重的安全漏洞，从未公开过
    2. SSL 2.0：1995年，已于2011年弃用（RFC 6176）
    3. SSL 3.0：1996年，已于2015年弃用（RFC 7568）
    4. TLS 1.0：1999年（[RFC 2246](https://tools.ietf.org/html/rfc2246)）
    5. TLS 1.1：2006年（[RFC 4346](https://tools.ietf.org/html/rfc4346)）
    6. TLS 1.2：2008年（[RFC 5246](https://tools.ietf.org/html/rfc5246)）
    7. TLS 1.3：2018年（[RFC 8446](https://tools.ietf.org/html/rfc8446)）
        1. 有没有发现：TLS的RFC文档编号都是以46结尾
5. SSL/TLS工作在哪一层
    1. 在传输层与应用层之间
    2. 因为SSL/TLS是对HTTP报文进行加密的，HTTP报文下一步传递到传输层，所以如果加密只能在传输层之前。

#### OpenSSL
1. [OpenSSL](https://www.openssl.org)是SSL/TLS协议的开源实现，始于1998年，支持Windows、Mac、Linux等平台
    1. Linux、Mac一般自带OpenSSL
    2. Windows下载安装OpenSSL：[https://slproweb.com/products/Win32OpenSSL.html](https://slproweb.com/products/Win32OpenSSL.html)
2. 常用命令
    1. 生成私钥：`openssl genrsa -out mj.key`
    2. 生成公钥：`openssl rsa -in mj.key -pubout -out mj.pem`
        1. 注意：只有给出公钥的路径`mj.key`,才能生成私钥
3. 可以使用OpenSSL构建一套属于自己的CA，自己给自己颁发证书，称为“自签名证书”


#### HTTPS的成本
1. 证书的费用
2. 加解密计算
3. 降低了访问速度
4. 有些企业的做法是：包含敏感数据的请求才使用HTTPS，其他保持使用HTTP
    1. 比如工商银行： http://www.icbc.com.cn/
    
### TLS1.2的连接
1. HTTPS的通信过程总的可以分为3大阶段
    1. TCP的3次握手
    2. TLS的连接
    3. HTTP请求和响应
2. 大概是有10大步骤，如下图
    1. 图片中省略了中间产生的一些ACK确认
    
    ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/wlxy-58.png)
3. 通过wireshark抓取https请求数据如下
    ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/wlxy-59.png)

#### 1.第一步Client Hello
1. 主要发送的内容有：
    1. TLS的版本号
    2. 支持的加密组件（Cipher Suite）列表
        1. 加密组件是指所使用的加密算法及密钥长度等 
        2. 一个随机数（Client Random）
    
#### 2.第二步Server Hello
1. 主要发送的内容有：
    1. TLS的版本号
    2. 选择的加密组件
        1. 是从接收到的客户端加密组件列表中挑选出来的，就是服务器所支持的
    4. 一个随机数（Server Random）

#### 3.第三步Certificate
1. 主要发送的内容有：
    1. 服务器的公钥证书（被CA签名过的）

#### 4.第四步Server Key Exchange
1. Server Key Exchange主要发送的内容有
    1. 用以实现ECDHE算法的其中一个参数（Server Params）
        1.  ECDHE是一种密钥交换算法
        2. 为了防止伪造，Server Params经过了服务器私钥签名

#### 5.第五步Server Hello Done
1. Server Hello Done主要发送的内容有
    1. 告知客户端：协商部分结束
2. 目前为止，客户端和服务器之间通过明文共享了
    1. Client Random、Server Random、Server Params
3.  而且，客户端也已经拿到了服务器的公钥证书，接下来，客户端会验证证书的真实有效性

#### 6.第六步Client Key Exchange
1. 客户端发送给服务器的用以实现ECDHE算法的另一个参数（Client Params）
2. 目前为止，客户端和服务器都拥有了ECDHE算法需要的2个参数：Server Params、Client Params
3. 客户端、服务器都可以
    1. 使用ECDHE算法根据Server Params、Client Params计算出一个新的随机密钥串：Pre-master secret
    2. 然后结合Client Random、Server Random、Pre-master secret生成一个主密钥
    3. 最后利用主密钥衍生出其他密钥：客户端发送用的会话密钥、服务器发送用的会话密钥

#### 7.第七步Change Cipher Spec
1. 告知服务器：之后的通信会采用计算出来的会话密钥进行加密


#### 8.第八步Finished
1. 包含连接至今全部报文的整体校验值（摘要），加密之后发送给服务器
2. 这次握手协商是否成功，要以服务器是否能够正确解密该报文作为判定标准

#### 9.第九十步Change Cipher Spec 、Finished
1. 到此为止，客户端服务器都验证加密解密没问题，握手正式结束 
2. 后面开始传输加密的HTTP请求和响应

![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/wlxy-60.png)

