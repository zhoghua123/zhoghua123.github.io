---
layout: post
title: 第六章 传输层(一)
category: 计算机网络
tags: 计算机网络
description: 计算机网络
---


## ***三、Internet的传输协议***
1. TCP和UDP都是Internet提供的传输层协议
    1. UDP (User Datagram Protocol)
    2. TCP (Transmission Control Protocol) 

### UDP (User Datagram Protocol)

#### UDP简介
1. UDP协议是无连接的数据报协议，它不提供可靠性服务，但其相应的协议开销也较小、效率较高 
2. 域名系统DNS、简单网络管理协议SNMP使用的传输层协议是UDP

#### UDP提供的服务
1. UDP是面向非连接的，与IP协议相比，它唯一增加的能力是提供端口协议（就是添加了一个端口号），以保证进程通信，传输的可靠性要靠应用程序来解决，但效率高
2. 适应的范围：
    1. 传输质量不是要求很高的
    2. 文本信息（其可靠性有传输层来保证）
3. UDP的数据报格式        
    ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/translate15.png)
    1. UDP源端口：（发送方的进程）UDP端口号，当不需要返回数据时，源端口域置0 
    2. UDP目的端口：UDP端口号（接收方的应用进程）
    3. UDP长度：整个数据段的长度，包括头部和数据部分以字节计，最小值为8（仅头部长度） 
    4. UDP校验和：可选域，全0为未选，全1表示校验和为0
4. UDP数据段的封装 
    ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/translate16.png)
    1. 当一个应用进程要用UDP来传输数据时
    2. 首先这个应用进程把数据交给UDP
    3. UDP把这个数据进行封装
        1. 就是在数据段前面加上UDP的头部，就是上面数据报的4个字节的内容
    4. UDP交给IP协议，整个UDP的PDU作为IP的数据包，封装在IP的数据区
    5. 然后IP协议在前面加上一个IP的报头
    6. 最后这个数据包通过IP协议传递出去了
    
#### UDP提供服务的应用
1. 常用哪些形式？
    1. 传输信息量很少的
    2. 实时信息的传输

##### RPC（Remote Procedure Call）（信息量少）
1. 传输信息很少的应用，通常我们把它看成是一个函数，传一个参数，返回一个返回值，区别就是函数调用在本地，而这种方式调用时在远程
2. 远程过程调用RPC 
    1. 将网络中的请求-应答交互表示成**过程调用形式（就是想函数调用一样）**，例如：调用get-IP-address（主机名）将发送一个UDP包给DNS服务器，并等待回答
    2. RPC对程序员屏蔽了网络运作的细节
    3. RPC是UDP的一个重要应用
3. 一次RPC的过程 
    ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/translate17.png)      
    
    1. 客户机通过在本地调用Client stub，使用常规的方法将参数压栈
    2. Client stub把参数封装（marshal）成消息并通过系统调用进行发送
    3. 客户机操作系统内核通过网络发送消息到服务器
    4. 服务器操作系统内核通过网络从客户机接收消息
    5. Server stub调用服务器进程对参数进行拆封
    6. 应答即为同一路径的逆向过程
    7. 注意：Stub是一个程序模块，用于在客户机和服务器之间传输远程过程调用和响应的承接程序
4. RPC的应用
    1. RPC是客户机/服务器模式中实现分布式计算的通信协议
    2. RPC采用非连接对话方式，具有错误控制能力
    3. RPC使服务器系统使用客户机提供的参数，执行客户机指定的规程并返回结果
    4. 从逻辑上看，按OSI的七层构架，RPC属会话层协议，但有些功能属应用层

##### RTP（Real-Time Transport Protocol）（实时传输）
1. 实时传输的特点： 
    1. 丢失了一个包没关系，但是必须保证时间的实时性
2. 实时传输协议RTP 
    1. 由于不需要连接的时间，可以保证实时性
    2. UDP的另一个重要应用是RTP
    3. RTP是一个传输层协议，但在应用层实现
    4. RTP是用于多媒体数据传输的协议
        1. 啥是多媒体传输？ 
        2. 就比如直播，在直播的过程中，要传输声音、图像、屏幕上面的信息等等多种媒体，同时传播过去
        3. 这几种数据流传播过去都是要有机的结合起来的，声音、头像、图片要同步，所以多个数据流之间就有一定的关系，那么怎么处理这些关系呢？
        4. RTP就支持这种传输，在一个UDP流当中，即一个应用进程到另一个应用进程当中及时传递各种各样的数据
        5. RTP协议就是基于UDP接口上面的协议。
        6. 因此做一个多媒体应用，这种传输的协议就是RTP传输
        
        ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/translate18.png)

3. RTP的功能 
    1. 将多个实时数据流多路复用到一个UDP流上，UDP流能被送给某个地址（单址传输）或多个地址（多址传输）
        1. 每个RTP流的数据包有一个连续的编号，接收方可以根据此编号确定是否有数据包丢失
        2. RTP没有流量控制、差错控制、应答以及重传机制
        3. RTP的载荷可以是不同的多媒体信息，如单个的音频流，可以是8 bit-8 kHz的PCM编码，也可以是GSM、MP3等，那么也就必须把这个编码方式传给对方，才能解码
        4. 编码方式在RTP的包头上指出
    2. 实时应用的另一个特征是需要时间戳，时间戳是相对于流的第一个数据包的，这有助于在接收方消除抖动，以及多个流的同步（如数字电视中的视频流和两个音频流）（就是保证声音和视频的同步）
4. RTP的头部格式 
    ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/translate19.png)
5. RTP的头部字段 
    1. P：指出数据包是否被填充为4字节的整倍数
    2. X：是否有扩展头
    3. CC：有多少个有效源（0-15），用于多路复用；（就是有几种媒体流传输）
    4. M：应用指定的标记位，如表示video帧的开始、音频通道中文字的开始或其它可理解的应用
    5. 载荷类型：信息的编码方式（如非压缩的8 bit音频、MP3等）
    6. 顺序号：RTP包的序号，以此检查是否丢包
    7. 时间戳：由发送源产生，表示与第一个包的时间间隔
    8. 同步源标记：数据包属于哪个流，用于多路复用或解多路复用
    9. 有效源标记：用于混合数据源，如果该字段出现，则该混合源是同步数据源，每个分数据源被列在这里
6. RTP的姐妹协议RTCP （略）
    1. RTCP（Realtime Transport Control Protocol）
实时传输控制协议
    2. RTCP处理反馈、同步和用户接口，而不传输数据
    3. 反馈消息包括延时、抖动、带宽、拥塞以及其它网络性能，可协调源端的传输速率、编码方式等，以适应当前的传输环境，得到最好的服务质量
    4. 同步是指不同的流数据可以用不同的时钟、不同的颗粒度、不同的速率进行传输，而RTCP可使其保持同步
    5. RTCP提供一种对不同的源端进行命名的方法，这将使接收方可在屏幕上显示当前谁在发送数据
    
### TCP (Transmission Control Protocol)
1. TCP提供的服务 
    1. 面向连接（Connection Orientation）
    2. 端到端的服务（End – to – End Communication）（每个端表示一个应用进程）
        1. 就是应用进程到应用进程之间的服务
    3. 完全可靠性服务（Complete Reliability）
        1. IP协议不提供可靠性服务，而TCP将在IP的基础上提供可靠性服务并保证数据发送和接收次序一致
    4. 全双工服务（Full Duplex Communication）
        1. 就是连接建立起来以后双方都可以发送和接收数据
    5. 流接口（Stream Interface）（TCP/UDP的不同之处） 
        1. 不是像IP一样每个数据包标识是数据包的编号，而TCP是字节流的序号
    6. 可靠的连接建立（Reliable Connection Startup） （**三次握手**）
    7. 完美的连接终止（Graceful Connection Shutdown） （**三次握手**）
2. TCP协议将讨论： 
    1. TCP服务模型 
    2. TCP数据段头 
    3. TCP连接和释放管理 
    4. TCP传输策略 
    5. TCP拥塞控制 
    6. TCP定时器管理 

#### TCP服务模型 
1. 端口port
    1. 应用进程的标识
    2. TCP的TSAP，与某一个应用程序相关
    2. 通用端口（well-known port） 端口号小于1024
    3. 其他可由各主机自己定义
2. 套接字socket 
    1. 传输层的通信端点，它由 **IP地址 + 端口号** 组成，internet中的唯一套接字
    2. **准确的说套接字就是： IP地址 + 端口号**
3. 常用TCP端口表     
    ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/translate21.png)
4. 套接字举例 
    1. 一个套接字允许被多个连接同时使用，即多个连接可同时连接到同一个套接字上      
         ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/translate20.png)


