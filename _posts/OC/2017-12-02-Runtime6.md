---
layout: post
title: Runtime系列5之-协议与分类
category: iOS开发
tags: Runtime
description: Runtime
--- 

Objective-C中的分类允许我们通过给一个类添加方法来扩充它（但是通过category不能添加新的实例变量），并且我们不需要访问类中的代码就可以做到。      
Objective-C中的协议是普遍存在的接口定义方式，即在一个类中通过@protocol定义接口，在另外类中实现接口，这种接口定义方式也成为“delegation”模式，@protocol声明了可以被其他任何方法类实现的方法，协议仅仅是定义一个接口，而由其他的类去负责实现。  
在本章中，我们来看看runtime对分类与协议的支持。

## Category

Category是表示一个指向分类的结构体的指针，其定义如下：

```
typedef struct objc_category *Category;
struct objc_category {
    char *category_name                          OBJC2_UNAVAILABLE;	// 分类名
    char *class_name                             OBJC2_UNAVAILABLE;	// 分类所属的类名
    struct objc_method_list *instance_methods    OBJC2_UNAVAILABLE;	// 实例方法列表
    struct objc_method_list *class_methods       OBJC2_UNAVAILABLE;	// 类方法列表
    struct objc_protocol_list *protocols         OBJC2_UNAVAILABLE;	// 分类所实现的协议列表
}
```
这个结构体主要包含了分类定义的实例方法与类方法，其中instance_methods列表是objc_class中方法列表的一个子集，而class_methods列表是元类方法列表的一个子集。

### Category函数  

Runtime并没有在`<objc/runtime.h>`头文件中提供针对分类的操作函数。因为这些分类中的信息都包含在objc_class中，我们可以通过针对objc_class的操作函数来获取分类的信息。如下例所示：

```javascript
//RuntimeCategoryClass.h
#import <Foundation/Foundation.h>
@interface RuntimeCategoryClass : NSObject
- (void)method1;
@end

@interface RuntimeCategoryClass (Category)
- (void)method2;
@end
//RuntimeCategoryClass.m
#import "RuntimeCategoryClass.h"

@implementation RuntimeCategoryClass
- (void)method1 {
}
@end
@implementation RuntimeCategoryClass (Category)
- (void)method2 {
}
@end
//调用:

#import "ViewController.h"
#import "RuntimeCategoryClass.h"
#import <objc/runtime.h>
@interface ViewController ()
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
#pragma mark -
    NSLog(@"测试objc_class中的方法列表是否包含分类中的方法");
    unsigned int outCount = 0;
    Method *methodList = class_copyMethodList(RuntimeCategoryClass.class, &outCount);
    for (int i = 0; i < outCount; i++) {
        Method method = methodList[i];
        const char *name = sel_getName(method_getName(method));
        NSLog(@"RuntimeCategoryClass's method: %s", name);
        if (strcmp(name, sel_getName(@selector(method2)))) {
            NSLog(@"分类方法method2在objc_class的方法列表中");
        }
    }
}
```
打印结果如下:

```
2014-11-08 10:36:39.213 [561:151847] 测试objc_class中的方法列表是否包含分类中的方法
2014-11-08 10:36:39.215 [561:151847] RuntimeCategoryClass's method: method2
2014-11-08 10:36:39.215 [561:151847] RuntimeCategoryClass's method: method1
2014-11-08 10:36:39.215 [561:151847] 分类方法method2在objc_class的方法列表中
```



