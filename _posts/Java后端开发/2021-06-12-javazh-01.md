---
layout: post
title: Java常用企业框架-MyBatis(三)
category: Java后端开发
tags: Java后端开发
description: Java后端开发
--- 

## 多表查询
1. 多表关系
    1. 数据库的表之间可能存在一定的关系
        1. 一对多、多对一：人可以有多张银行卡，一张银行卡只能有一个人
        2. 一对一：人只有一张身份证
        3. 多对多：人与职业之间的关系，1个人可以同时干n个职位，1个职位可以有n个人
2. 各种数据的bean设计如下图所示
    ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-26.png)
3. 如何在MyBatis中表达这中多表关系呢？

### 代码举例
#### 1.创建表结构
    
```
# drop
DROP TABLE IF EXISTS bank_card;
DROP TABLE IF EXISTS id_card;
DROP TABLE IF EXISTS person_job;
DROP TABLE IF EXISTS person;
DROP TABLE IF EXISTS job;
    
# person
CREATE TABLE person(
	id INT PRIMARY KEY AUTO_INCREMENT,
	name VARCHAR(20) NOT NULL
);
    
# bank_card
CREATE TABLE bank_card(
	id INT PRIMARY KEY AUTO_INCREMENT,
	no VARCHAR(30) NOT NULL UNIQUE,
	amout DECIMAL(18, 2) NOT NULL,
	person_id INT NOT NULL,
	FOREIGN KEY (person_id) REFERENCES person(id)
);
    
# id_card
CREATE TABLE id_card(
	id INT PRIMARY KEY AUTO_INCREMENT,
	no VARCHAR(30) NOT NULL UNIQUE,
	address VARCHAR(50) NOT NULL,
	person_id INT NOT NULL UNIQUE,
	FOREIGN KEY (person_id) REFERENCES person(id)
);
    
# job
CREATE TABLE job(
	id INT PRIMARY KEY AUTO_INCREMENT,
	name VARCHAR(20) NOT NULL UNIQUE,
	duty VARCHAR(50) NOT NULL
);
    
# person_job
CREATE TABLE person_job(
	person_id INT,
	job_id INT,
	PRIMARY KEY (person_id, job_id),
	FOREIGN KEY (person_id) REFERENCES person(id),
	FOREIGN KEY (job_id) REFERENCES job(id)
);
    
# data
INSERT INTO person(name) VALUES ('Jack'), ('Rose'), ('Larry'), ('Mike'), ('Tom'), ('James');
    
INSERT INTO id_card(no, address, person_id) VALUES 
('9527', '北京', 4),
('8866', '广州', 1),
('2495', '上海', 5),
('4378', '成都', 2),
('5454', '杭州', 6),
('9923', '深圳', 3);
    
INSERT INTO bank_card(no, amout, person_id) VALUES 
('6223', 0, 1),
('75556', 2098.56, 2),
('5345', 1010000.56, 1),
('87876', 534423.34, 3),
('654645', 432.45, 1),
('5434534', 234765.19, 4),
('76853', 98945.39, 4),
('6456867', 435534.78, 1),
('4324654', 874343.99, 4),
('53455', 5.20, 2);
    
INSERT INTO job(name, duty) VALUES 
('程序员', '每一天都在写新的bug和修改昨天的bug'),
('保安', '公司全系统物理安全保障专员'),
('网管', '世界互联网信息终端及人类信息科技部信息集成应用导师'),
('厨师', '类口腔神经末梢感应实验中心及绿色环保邮寄肥转换加工基地负责人'),
('贴膜', '智能高端移动设备表面高化合物平面处理'),
('搬砖', '长方体混泥土瞬间移动师'),
('算命', '主观性逻辑推论及心理引导'),
('理发师', '人体无用副组织切除手术主刀');
    
INSERT INTO person_job(person_id, job_id) VALUES 
(1, 1),
(1, 3),
(1, 5),
(1, 7),
(2, 5),
(3, 1),
(3, 2),
(5, 3),
(5, 5),
(5, 7);
```

#### 2.创建bean对象（略）

#### 3.`mybatis-config.xml`添加mapper
    
```
<!-- 映射文件 -->
<mappers>
    <mapper resource="mappers/person.xml"/>
    <mapper resource="mappers/idCard.xml"/>
    <mapper resource="mappers/bankCard.xml"/>
    <mapper resource="mappers/job.xml"/>
</mappers>
```
    
#### 4.mappers对应的bean.xml如下

1. person.xml
    
    ```
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="person">
        <!--查询人信息对应的：身份证信息、银行卡信息、工作信息-->
        <sql id="sqlListAll">
            SELECT
                p.*,
                ic.id id_card_id,
                ic.no id_card_no,
                ic.address id_card_address,
                bc.id bank_card_id,
                bc.no bank_card_no,
                bc.amout bank_card_amout,
                j.id job_id,
                j.name job_name,
                j.duty job_duty
            FROM
                person p
            JOIN id_card ic ON p.id = ic.person_id
            LEFT JOIN bank_card bc ON p.id = bc.person_id
            LEFT JOIN person_job pj ON p.id = pj.person_id
            LEFT JOIN job j ON j.id = pj.job_id
        </sql>
    
        <resultMap id="rmList" type="com.zh.bean.Person">
            <id property="id" column="id"/>
            <result property="name" column="name"/>
            <!--映射内容是一个对象，即bean有一个对象bean属性属性-->
            <association property="idCard"
                         javaType="com.zh.bean.IdCard">
                <id property="id" column="id_card_id"/>
                <result property="no" column="id_card_no"/>
                <result property="address" column="id_card_address"/>
            </association>
            <!--映射内容是一个集合，即bean有一个集合属性，集合中存放bean对象-->
            <collection property="bankCards" ofType="com.zh.bean.BankCard">
                <id property="id" column="bank_card_id"/>
                <result property="no" column="bank_card_no"/>
                <result property="amout" column="bank_card_amout"/>
            </collection>
            <collection property="jobs" ofType="com.zh.bean.Job">
                <id property="id" column="job_id"/>
                <result property="name" column="job_name"/>
                <result property="duty" column="job_duty"/>
            </collection>
        </resultMap>
    
        <select id="list" resultMap="rmList">
            <include refid="sqlListAll"/>
        </select>
    
        <select id="get" parameterType="int" resultMap="rmList">
            <include refid="sqlListAll"/> WHERE p.id = #{id}
        </select>
    </mapper>
    ```
2. idCard.xml
    
    ```
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="idCard">
        <!--查询所有的身份证信息对应的： 人的信息-->
        <sql id="sqlListAll">
            SELECT
                ic.*,
                p.name person_name
            FROM
                id_card ic
            JOIN person p ON p.id = ic.person_id
        </sql>
    
        <resultMap id="rmList" type="com.zh.bean.IdCard">
            <id property="id" column="id"/>
            <result property="no" column="no"/>
            <result property="address" column="address"/>
            <association property="person"
                         javaType="com.zh.bean.Person">
                <id property="id" column="person_id"/>
                <result property="name" column="person_name"/>
            </association>
        </resultMap>
    
        <select id="list" resultMap="rmList">
            <include refid="sqlListAll"/>
        </select>
    
        <select id="get" parameterType="int" resultMap="rmList">
            <include refid="sqlListAll"/> WHERE ic.id = #{id}
        </select>
    </mapper>
    ```
3. bankCard.xml
    
    ```
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="bankCard">
        <!--查询所有的银行卡信息对应的：人的信息-->
        <sql id="sqlListAll">
            SELECT
                bc.*,
                p.name person_name
            FROM
                bank_card bc
            JOIN person p ON p.id = bc.person_id
        </sql>
    
        <resultMap id="rmList" type="com.zh.bean.BankCard">
            <id property="id" column="id"/>
            <result property="no" column="no"/>
            <result property="amout" column="amout"/>
            <association property="person"
                         javaType="com.zh.bean.Person">
                <id property="id" column="person_id"/>
                <result property="name" column="person_name"/>
            </association>
        </resultMap>
    
        <select id="list" resultMap="rmList">
            <include refid="sqlListAll"/>
        </select>
    
        <select id="get" parameterType="int" resultMap="rmList">
            <include refid="sqlListAll"/> WHERE bc.id = #{id}
        </select>
    </mapper>
    ```
4. job.xml
    
    ```
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="job">
        <!-- 查询所有的职业信息，对应的人的信息 -->
        <sql id="sqlListAll">
            SELECT
                j.*,
                p.id person_id,
                p.name person_name
            FROM
                job j
            LEFT JOIN person_job pj ON j.id = pj.job_id
            LEFT JOIN person p ON p.id = pj.person_id
        </sql>
    
        <resultMap id="rmList" type="com.zh.bean.Job">
            <id property="id" column="id"/>
            <result property="name" column="name"/>
            <result property="duty" column="duty"/>
            <collection property="persons" ofType="com.zh.bean.Person">
                <id property="id" column="person_id"/>
                <result property="name" column="person_name"/>
            </collection>
        </resultMap>
    
        <select id="list" resultMap="rmList">
            <include refid="sqlListAll"/>
        </select>
    
        <select id="get" parameterType="int" resultMap="rmList">
            <include refid="sqlListAll"/> WHERE j.id = #{id}
        </select>
    </mapper>
    ```

#### 5.test测试

```
//OneToOne
public class OneToOne {
    @Test
    //查询所有的人信息：n个人对应n张身份证
    public void personList() {
        try (SqlSession session = MyBatises.openSession()) {
            List<Person> persons = session.selectList("person.list");
            System.out.println(persons);
        }
    }

    @Test
    //查询某个人
    public void personGet() {
        try (SqlSession session = MyBatises.openSession()) {
            Person person = session.selectOne("person.get", 1);
            System.out.println(person);
        }
    }

    @Test
    //查询所有的身份证信息
    public void idCardList() {
        try (SqlSession session = MyBatises.openSession()) {
            List<IdCard> idCards = session.selectList("idCard.list");
            System.out.println(idCards);
        }
    }

    @Test
    //查询某个身份证
    public void idCardGet() {
        try (SqlSession session = MyBatises.openSession()) {
            IdCard idCard = session.selectOne("idCard.get", 1);
            System.out.println(idCard);
        }
    }
}

//OneToMany
public class OneToMany {
    //n个人对应多张银行卡
    @Test
    public void personList() {
        try (SqlSession session = MyBatises.openSession()) {
            List<Person> persons = session.selectList("person.list");
            System.out.println(persons);
        }
    }

    //一个人对应n张银行卡
    @Test
    public void personGet() {
        try (SqlSession session = MyBatises.openSession()) {
            Person person = session.selectOne("person.get", 1);
            System.out.println(person);
        }
    }

    //n张银行卡对应n个人
    @Test
    public void bankCardList() {
        try (SqlSession session = MyBatises.openSession()) {
            List<BankCard> bankCards = session.selectList("bankCard.list");
            System.out.println(bankCards);
        }
    }

    //一张银行卡对应1个人
    @Test
    public void bankCardGet() {
        try (SqlSession session = MyBatises.openSession()) {
            BankCard bankCard = session.selectOne("bankCard.get", 1);
            System.out.println(bankCard);
        }
    }
}

//ManyToMany
public class ManyToMany {
    //多有的人
    @Test
    public void personList() {
        try (SqlSession session = MyBatises.openSession()) {
            List<Person> persons = session.selectList("person.list");
            System.out.println(persons);
        }
    }

    //一个人对应多张工作
    @Test
    public void personGet() {
        try (SqlSession session = MyBatises.openSession()) {
            Person person = session.selectOne("person.get", 1);
            System.out.println(person);
        }
    }

    //n个工作，对应多个人
    @Test
    public void jobList() {
        try (SqlSession session = MyBatises.openSession()) {
            List<Job> jobs = session.selectList("job.list");
            System.out.println(jobs);
        }
    }

    //一份工作对应n个人
    @Test
    public void jobGet() {
        try (SqlSession session = MyBatises.openSession()) {
            Job job = session.selectOne("job.get", 1);
            System.out.println(job);
        }
    }
}
```    




