---
layout: post
title: Java进阶-Nginx
category: Java后端开发
tags: Java后端开发
description: Java后端开发
---  

### Nginx简介
1. Nginx (engine x) **是**一个高性能的HTTP（网络**静态**资源服务器）和反向代理**服务器**，也是一个IMAP/POP3/SMTP服务器。
    1. 动态请求：需要后台程序处理逻辑，比如：查询数据库数据-》后台技术：web技术
    2. 静态请求：处理静态资源（html、js、css）
    3. Nginx只能处理静态请求，Tomcat技能处理动态请求也能处理动态请求。
2. Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。 开源。 也有商业版本：Nginx plus--> 商业版
3. 其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。
4. Tomcat: 150并发; Nginx: 并发量官方文档5w，实际3w没有问题，而且占用内存150M左右
5. 总结：
    1. Nginx就是一个后台服务器软件，跟tomcat一样，把项目包放到软件某个目录下即可
    2. Tomcat既可以存放静态资源、也可以存放动态资源；Nginx专门用来存放静态资源

#### 1.正向代理和反向代理
1. 正向代理:比如要访问youtube,但是不能直接访问，只能先找个翻墙软件，通过翻墙软件才能访问youtube. 这种方式就叫做**正向代理**。
    
    ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-59.png) 
    
    1. 分析
        1. 客户端做代理服务器的相关配置（代理服务器的地址等），然后访问推特网站
        2. 代理服务器会将推特访问包装成访问代理服务器的请求
        3. 防火墙没有对代理服务器进行限制，会访问到墙外部署的代理服务器
        4. 代理服务器获取到封装请求，解封装去访问推特网站服务器
        5. 推特网站响应数据，代理服务器将响应数据进行包装，翻墙到客户端
        6. 客户端拿到包装的响应进行解包展示
    2. **正向代理的特点：**
        1. 客户端是知道目标访问地址（代理服务器的地址）
        2. 代理服务器专门对客户端工作的
        3. 这台服务器专门为客户端工作，就是一个代理，所以叫代理服务器
2. 反向代理:指的是用户要访问youtube,但是youtube悄悄地把这个请求交给后台N台服务器中的其中一台来做，这种方式就是反向代理了。
    
    ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-60.png) 
    
    1. 分析：
        1. 客户端发送域名请求数据
        2. 由于请求量并发量非常大，因此后台部署了n台服务器
        3. 客户端请求数据先到nginx服务器
        4. nginx服务器来进行分配具体的目标服务器
        5. 目标服务器响应数据给nginx服务器，然后返回给客户端
        6. 这里的nginx服务器也是一个代理作用，但是它不是为客户端做代理，而是为服务器做代理，因此也叫反向代理服务器
    2. 反向代理特点：
        1. 主要给后台应用提供服务，代理的就是服务端，保护服务端，防止对外暴露，客户端有请求找我就行
        2. 对于客户端来说根本不知道请求的URI是有哪个服务器提供的服务
3. 总结：
    1. 正向代理服务就是代替客户端去向**已知**的服务器发送请求
    2. 反向代理服务器就是代替后端服务器去接收客户端的请求

#### 2.常见的负载均衡策略
1. 使用硬件负载均衡策略,如使用F5,Array等负载均衡器.（比较贵）
2. 使用软件进行负载均衡Nginx, 自己封装的负载均衡服务器
3. 如使用阿里云服务器均衡SLB
4. 使用Nginx+Keepalived
5. 其他软件负载均衡如LVS(Linux Virtual Server),haproxy等技术

#### 3.Nginx优点
1. Nginx 可以在大多数 Unix、Linux OS 上编译运行，并有 Windows 移植版。 Nginx 的1.4.0稳定版已经于2013年4月24日发布，一般情况下，对于新建站点，建议使用最新稳定版作为生产版本，已有站点的升级急迫性不高。
2. Nginx 的源代码使用 2-clause BSD-like license。
3. Nginx 是一个很强大的高性能Web和反向代理服务器，它具有很多非常优越的特性：
    1. 在连接高并发的情况下，Nginx是Apache服务器不错的替代品：Nginx在美国是做虚拟主机生意的老板们经常选择的软件平台之一。能够支持高达 50,000 个并发连接数的响应，感谢Nginx为我们选择了 epoll and kqueue作为开发模型。
5. 下载
    1. 
    2. 比如:`nginx-1.20.1 `

#### 4.环境搭建（Linux安装）
1. 下载安装包
    1. 打开网址`https://nginx.org/`，点击右侧`download`，下载最新的Stable version，点击`nginx-1.20.1`即可下载`nginx-1.20.1.tar.gz`
2. 将安装包上传到Linux的文件目录下：`/usr/local/software`文件夹下
3. 安装所需要的依赖库文件:
    
    ```
    yum install pcre -y
    yum install pcre-devel -y
    yum install zlib -y
    yum install zlib-devel -y
    ```
4. 将安装包源码解压到指定安装目录
    
    ```
    tar -zxvf nginx-1.20.1.tar.gz -C /usr/local/src
    ```
5. `cd /usr/local/src/nginx-1.20.1`中，ls查看，会发现有个configure命令
6. `./configure --prefix=/usr/local/nginx` 配置将源码编译到哪个目录下
7. 编译安装: 当前目录下执行 `make && make install`
8. 在 /usr/local/nginx目录下,可以看到如下4个目录
    
    ```
    conf 配置文件目录
    html 默认的HTML页面目录 
    logs 日日志存放目录 
    sbin 执行命令目录
    ```
9. 常用命令
    
    ```
    启动命令:/usr/local/nginx/sbin/nginx
    关闭命令:/usr/local/nginx/sbin/nginx -s stop
    重启命令:/usr/local/nginx/sbin/nginx -s reload
    ```
    
    1. 注意：nginx默认使用的是80端口
    2. 可以使用`netstat -ano| grep 80` 查看端口
10. 访问浏览器:http://192.168.122.133(看到欢迎页面说明没问题)
11. 注意:如果出现这个错误:./configure: error: C compiler cc is not found
    1. 执行这个命令:yum -y install gcc gcc-c++ autoconf automake make

#### 5.MacOS安装
1. 安装（可以用 brew 安装）
    
    ```
    //安装（可以用 brew 安装）
    brew install nginx
    //查看 nginx 版本
    nginx -v
    //启动 nginx
    nginx
    //也可以使用下面的命令启动，但是配置文件nginx.conf修改后用这个命令执行不生效，故不建议使用：    
    brew services start nginx
    
    //查看 nginx 是否启动成功
    //在浏览器中访问http://localhost:8080，如果出现欢迎界面，证明成功.
    //备注：端口号是在配置文件 nginx.conf 里面配置的，默认端口是 8080 ，配置文件的位置 /usr/local/etc/nginx
    
    //关闭nginx
    nginx -s stop
    
    //也可以使用下面的命令启动，但是配置文件nginx.conf修改后用这个命令执行不生效，故不建议使用：

    brew services stop nginx
    //修改配置后，重新加载nginx
    nginx -s reload
    //可能遇到的问题
    端口被占用： 解决方法，修改 nginx.conf 文件里的端口号
    ```

### Nginx通用语法
1. 配置文件有指令和指令块构成
2. 每条指令以分号(;)结尾, 指令和参数之间用空格符号进行分隔
3. 指令块以`{}`大括号将多条指令组织在一起
4. `include`语句允许组合多个配置文件以提升可维护性,导入其他配置文件
5. 使用`#`符号添加注释, 提高可读性
6. 使用`$`符号引用变量
7. 部分指令的参数支持正则表达式

### Nginx基础概念
1. 多进程模式
    1. 在Nginx中会启动Master和Worker两种进程
    2. 其中Master进程主要的工作:
        1. 接收客户端的请求
        2. 向Worker进程发送信号
        3. 监控Worker进程的状态
        4. 当Worker进程退出以后, 会自动重新启动新的Worker进程
    3. 其中Worker进程主要是用来处理客户端的连接
    4. 就是Master进程用来管理，Worker进程用来具体处理任务
2. 配置文件结构
    1. 在/usr/local/nginx/conf目录下有个nginx.conf文件
    2. nginx.conf由多个块组成，最外面的块是main，main包含events和http,http包含多个upstream和多个server，server又包含多个location：
        1. main（全局设置）、server（虚拟主机设置）、upstream（上游服务设置, 负载均衡服务器设置）和 location（URL匹配特定位置的设置）。
            
            ```
            main块设置的指令将影响其他所有设置；
            server块的指令主要用于指定主机和端口；如果有多个服务器，那么对应的就有多个server
            upstream指令主要用于负载均衡，设置一系列的后端服务器；
            location块用于匹配网页位置。
            ```
        2. 这四者之间的关系式：server继承main，location继承server，upstream既不会继承其他设置也不会被继承。
   
### 常用配置
1. 虚拟主机配置
    
    ```
    server {
        #端口 一个server就对应一个服务，每个服务都有端口
        listen       80;
        #域名
        server_name  localhost;
        
        #资源路径
        location / {
            # 目录
            root   html;
            # 目录下的文件
            index  index.html index.htm;
        }
    }
    ```
    
    1. 一旦访问 http://localhost:80，则就会来到这个server，然后到html文件夹下找到index.html文件
2. 日志文件
    1. nginx访问日志放在log/host.access.log下,并且使用main格式(支持自定义格式)
    2. 对于main格式配置如下:
        
        ```
        #日志文件输出格式这个位置相当于全局设置
        #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
        #                  '$status $body_bytes_sent "$http_referer" '
        #                  '"$http_user_agent" "$http_x_forwarded_for"';
        
        #access_log  logs/access.log  main;
        
        查看日志内容命令:tail -n 100 -f access.log
        ```
3. 日志文件切分
    1. 系统运行起来之后,我们需要对nginx日志的分析,得到响应耗时的url,请求时间,以及这段时间的请求量和并发量.通过分析找到优化系统的方案.所以需要运维人员对nginx的日志进行切割和分析处理.我们会通过定时器定时将日志按天/小时进行备份.
    
    

### Nginx扩展

### 搭建高可用环境


