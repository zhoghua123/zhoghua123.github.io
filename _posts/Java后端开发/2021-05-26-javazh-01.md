---
layout: post
title: JavaEE开发-第六节 JavaEE项目实战(四)
category: Java后端开发
tags: Java后端开发
description: Java后端开发
--- 

## 个人信息页面
1. 展示、保存用户信息
### jsp全局访问数据问题：
1. 当个人信息页面的头像、名称等更改之后，左侧的导航栏上的信息也应该相应修改，但是左侧导航栏是嵌入到每一个页面的，那么当点击其他页面时（比如教育经验），如何获取这些信息呢？
2. 代码示例如下：
    
    ```
    //左侧导航的位置信息
    <div class="name">${user.name}</div>
    <div class="email">${user.job}</div>
    ```
    
3. jsp中这句话`${user.name}`的本质是
    1. 先通过`request.getAttribute("user").getName();`来获取
    2. 如果上面的方法获取不到，再通过Session来获取` request.getSession().getAttribute("user").getName();`
    3. 因此，只要Sesson中有值，可以全局获得，无论那个页面
    
#### 代码示例
1. 展示个人信息列表、保存用信息的接口如下：
    
```
//访问用户信息页面
public void admin(HttpServletRequest request, HttpServletResponse response) throws Exception {
    request.setAttribute("user", service.list().get(0));
    forward(request, response, "admin/user.jsp");
}
//保存用户信息
public void save(HttpServletRequest request, HttpServletResponse response) throws Exception {
    UploadParams params = Uploads.parseRequest(request);

    // 请求参数转成User
    User user = new User();
    BeanUtils.populate(user, params.getParams());

    // 从Session中拿到邮箱、密码
    User loginUser = (User) request.getSession().getAttribute("user");
    user.setEmail(loginUser.getEmail());
    user.setPassword(loginUser.getPassword());

    // 处理用户的头像
    FileItem item = params.getFileParam("photoFile");
    user.setPhoto(Uploads.uploadImage(item, request, user.getPhoto()));

    if (service.save(user)) { // 保存成功
        redirect(request, response, "user/admin");

        // 更新session中的用户信息
        request.getSession().setAttribute("user", user);
    } else {
        forwardError(request, response, "个人信息保存失败");
    }
}
```


### 退出登录
1. UserServlet中代码示例
    
    ```
    /**
     * 退出登录
     */
    public void logout(HttpServletRequest request, HttpServletResponse response) throws Exception {
        // 清除登录信息（将session中的用户删除）
        request.getSession().removeAttribute("user");

        // 重定向到登录页面
        redirect(request, response, "page/login.jsp");
    }
    ```

### 修改密码
1. 改造password.jsp
2. UserServlet中代码示例
    
    ```
    //展示修改密码页面
    public void password(HttpServletRequest request, HttpServletResponse response) throws Exception {
        forward(request, response, "admin/password.jsp");
    }
    //修改密码
    public void updatePassword(HttpServletRequest request, HttpServletResponse response) throws Exception {
        String oldPassword = request.getParameter("oldPassword");
        // 对比session中用户的密码
        User user = (User) request.getSession().getAttribute("user");
        if (!user.getPassword().equals(oldPassword)) {
            forwardError(request, response, "旧密码不正确");
            return;
        }

        // 保存新密码
        String newPassword = request.getParameter("newPassword");
        user.setPassword(newPassword);
        if (service.save(user)) { // 保存成功
            redirect(request, response, "page/login.jsp");
        } else {
            forwardError(request, response, "修改密码失败");
        }
    }
    ```

## 个人简历页面
1. 将front文件夹下的html代码抽取、整理成jsp（略）
2. 配置默认访问首页
    1. 当用户直接输入域名+端口+根目录（`http://localhost:8080/xr/`）的时候直接跳转到个人简历页面
    2. 通常默认的是访问webapp下面的index.htm、index.html、index.jsp
    3. 也可以通过web.xml配置，在web.xml下配置访问首页
    4. 直接输入`http://localhost:8080/xr/`就会跳转到个人简历页面
    5. 本质是执行`http://localhost:8080/xr/user/front`
    
    ```
    <!-- 配置首页 -->
    <welcome-file-list>
        <welcome-file>user/front</welcome-file>
    </welcome-file-list>
    ```
3. 个人简历页面UserServlet代码如下
    
    ```
    private SkillService skillService = new SkillServiceImpl();
    private AwardService awardService = new AwardServiceImpl();
    private WebsiteService websiteService = new WebsiteServiceImpl();

    /*
    对http://localhost:8080/xr/请求做特殊处理
    上面讲过，调用根路径本质是访问http://localhost:8080/xr/user/front，因此会来到UserServlet，但是此时的实际路径仍然是http://localhost:8080/xr/
    那么经过BaseServlet的doGet切割后，调用的是xr方法，很显然没有该方法，那么就需要重写父类的doGet，专门处理
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String uri = request.getRequestURI();
        //通过/切割
        String[] cmps = uri.split("/");
        //拿到最后一个访问路径名
        String methodName = "/" + cmps[cmps.length - 1];
        //1. 如果为根路径/xr，则就是访问个人简历页面
        if (methodName.equals(request.getContextPath())) {
            try {
                front(request, response);
            } catch (Exception e) {
                e.printStackTrace();
            }
        //2. 否则访问父类的doget方法
        } else {
            super.doGet(request, response);
        }
    }
    //个人简历页面
    public void front(HttpServletRequest request, HttpServletResponse response) throws Exception {
        //获取个人简历页面需要展示的数据信息
        // 用户信息
        User user = service.list().get(0);
        request.setAttribute("user", user);

        // 个人特质
        request.setAttribute("trait", user.getTrait().split(","));

        // 兴趣爱好
        request.setAttribute("interests", user.getInterests().split(","));

        // 专业技能
        request.setAttribute("skills", skillService.list());
        // 获奖成就
        request.setAttribute("awards", awardService.list());
        // 网站的底部信息
        request.setAttribute("footer", websiteService.list().get(0).getFooter());
        //转发到个人简历页面
        forward(request, response, "front/user.jsp");
    }
    ```
  
### 个人简历右侧的导航栏对应的页面  
1. 根据个人简历页面右边的导航栏，需要访问教育经验、工作经验、项目经验等简历模块页面（注意，跟管理端不一样）
2. 导航jsp中访问如下
        
    ```
    <li><a href="${ctx}/education/front" data-tooltip="教育经验"><span 
    class="crt-icon crt-icon-book"></span></a></li>
    <li><a href="${ctx}/experience/front" data-tooltip="工作经验"><span 
    class="crt-icon crt-icon-experience"></span></a></li>
    <li><a href="${ctx}/project/front" data-tooltip="项目经验"><span 
    class="crt-icon crt-icon-wrench"></span></a></li>
    <li><a href="${ctx}/contact/front" data-tooltip="联系我吧"><span 
    class="crt-icon crt-icon-contact"></span></a></li>
    <li><a href="${ctx}/user/admin" data-tooltip="后台管理"><span
    class="crt-icon crt-icon-key"></span></a></li>
    ```
3. 因此需要分别在EducationServlet/ExperienceServlet/ProjectServlet中添加相应的接口方法，例如项目经验
       
    ```
    //ProjectServlet中添加访问工作经验
    private UserService userService = new UserServiceImpl();
    private WebsiteService websiteService = new WebsiteServiceImpl();

    public void front(HttpServletRequest request, HttpServletResponse response) throws Exception {
        request.setAttribute("user", userService.list().get(0));
        request.setAttribute("footer", websiteService.list().get(0).getFooter());
        request.setAttribute("projects", service.list());
        forward(request, response, "front/project.jsp");
    }
    ```
    


