---
layout: post
title: JavaEEå¼€å‘-ç¬¬å…­èŠ‚ JavaEEé¡¹ç›®å®æˆ˜(å››)
category: Javaåç«¯å¼€å‘
tags: Javaåç«¯å¼€å‘
description: Javaåç«¯å¼€å‘
--- 

## ä¸ªäººä¿¡æ¯é¡µé¢
1. å±•ç¤ºã€ä¿å­˜ç”¨æˆ·ä¿¡æ¯

### jspå…¨å±€è®¿é—®æ•°æ®é—®é¢˜ï¼š
1. å½“ä¸ªäººä¿¡æ¯é¡µé¢çš„å¤´åƒã€åç§°ç­‰æ›´æ”¹ä¹‹åï¼Œå·¦ä¾§çš„å¯¼èˆªæ ä¸Šçš„ä¿¡æ¯ä¹Ÿåº”è¯¥ç›¸åº”ä¿®æ”¹ï¼Œä½†æ˜¯å·¦ä¾§å¯¼èˆªæ æ˜¯åµŒå…¥åˆ°æ¯ä¸€ä¸ªé¡µé¢çš„ï¼Œé‚£ä¹ˆå½“ç‚¹å‡»å…¶ä»–é¡µé¢æ—¶ï¼ˆæ¯”å¦‚æ•™è‚²ç»éªŒï¼‰ï¼Œå¦‚ä½•è·å–è¿™äº›ä¿¡æ¯å‘¢ï¼Ÿ
2. ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š
    
    ```
    //å·¦ä¾§å¯¼èˆªçš„ä½ç½®ä¿¡æ¯
    <div class="name">${user.name}</div>
    <div class="email">${user.job}</div>
    ```
3. jspä¸­è¿™å¥è¯`${user.name}`çš„æœ¬è´¨æ˜¯
    1. å…ˆé€šè¿‡`request.getAttribute("user").getName();`æ¥è·å–
    2. å¦‚æœä¸Šé¢çš„æ–¹æ³•è·å–ä¸åˆ°ï¼Œå†é€šè¿‡Sessionæ¥è·å–` request.getSession().getAttribute("user").getName();`
    3. å› æ­¤ï¼Œåªè¦Sessonä¸­æœ‰å€¼ï¼Œå¯ä»¥å…¨å±€è·å¾—ï¼Œæ— è®ºé‚£ä¸ªé¡µé¢
    
### ä»£ç ç¤ºä¾‹
1. å±•ç¤ºä¸ªäººä¿¡æ¯åˆ—è¡¨ã€ä¿å­˜ç”¨ä¿¡æ¯çš„æ¥å£å¦‚ä¸‹ï¼š
    
```
//è®¿é—®ç”¨æˆ·ä¿¡æ¯é¡µé¢
public void admin(HttpServletRequest request, HttpServletResponse response) throws Exception {
    request.setAttribute("user", service.list().get(0));
    forward(request, response, "admin/user.jsp");
}
//ä¿å­˜ç”¨æˆ·ä¿¡æ¯
public void save(HttpServletRequest request, HttpServletResponse response) throws Exception {
    UploadParams params = Uploads.parseRequest(request);

    // è¯·æ±‚å‚æ•°è½¬æˆUser
    User user = new User();
    BeanUtils.populate(user, params.getParams());

    // ä»Sessionä¸­æ‹¿åˆ°é‚®ç®±ã€å¯†ç 
    User loginUser = (User) request.getSession().getAttribute("user");
    user.setEmail(loginUser.getEmail());
    user.setPassword(loginUser.getPassword());

    // å¤„ç†ç”¨æˆ·çš„å¤´åƒ
    FileItem item = params.getFileParam("photoFile");
    user.setPhoto(Uploads.uploadImage(item, request, user.getPhoto()));

    if (service.save(user)) { // ä¿å­˜æˆåŠŸ
        redirect(request, response, "user/admin");

        // æ›´æ–°sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯
        request.getSession().setAttribute("user", user);
    } else {
        forwardError(request, response, "ä¸ªäººä¿¡æ¯ä¿å­˜å¤±è´¥");
    }
}
```

### é€€å‡ºç™»å½•

```
//é€€å‡ºç™»å½•-UserServlet
public void logout(HttpServletRequest request, HttpServletResponse response) throws Exception {
    // æ¸…é™¤ç™»å½•ä¿¡æ¯ï¼ˆå°†sessionä¸­çš„ç”¨æˆ·åˆ é™¤ï¼‰
    request.getSession().removeAttribute("user");

    // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
    redirect(request, response, "page/login.jsp");
}
```

### ä¿®æ”¹å¯†ç 
1. æ”¹é€ password.jsp
    
    ```
    //å±•ç¤ºä¿®æ”¹å¯†ç é¡µé¢-UserServlet
    public void password(HttpServletRequest request, HttpServletResponse response) throws Exception {
        forward(request, response, "admin/password.jsp");
    }
    //ä¿®æ”¹å¯†ç 
    public void updatePassword(HttpServletRequest request, HttpServletResponse response) throws Exception {
        String oldPassword = request.getParameter("oldPassword");
        // å¯¹æ¯”sessionä¸­ç”¨æˆ·çš„å¯†ç 
        User user = (User) request.getSession().getAttribute("user");
        if (!user.getPassword().equals(oldPassword)) {
            forwardError(request, response, "æ—§å¯†ç ä¸æ­£ç¡®");
            return;
        }

        // ä¿å­˜æ–°å¯†ç 
        String newPassword = request.getParameter("newPassword");
        user.setPassword(newPassword);
        if (service.save(user)) { // ä¿å­˜æˆåŠŸ
            redirect(request, response, "page/login.jsp");
        } else {
            forwardError(request, response, "ä¿®æ”¹å¯†ç å¤±è´¥");
        }
    }
    ```

## ä¸ªäººç®€å†é¡µé¢
1. å°†frontæ–‡ä»¶å¤¹ä¸‹çš„htmlä»£ç æŠ½å–ã€æ•´ç†æˆjspï¼ˆç•¥ï¼‰
2. **é…ç½®é»˜è®¤è®¿é—®é¦–é¡µ**
    1. å½“ç”¨æˆ·ç›´æ¥è¾“å…¥åŸŸå+ç«¯å£+æ ¹ç›®å½•ï¼ˆ`http://localhost:8080/xr/`ï¼‰çš„æ—¶å€™ç›´æ¥è·³è½¬åˆ°ä¸ªäººç®€å†é¡µé¢
    2. é€šå¸¸é»˜è®¤çš„æ˜¯è®¿é—®webappä¸‹é¢çš„index.htmã€index.htmlã€index.jsp
    3. ä¹Ÿå¯ä»¥é€šè¿‡web.xmlé…ç½®ï¼Œåœ¨web.xmlä¸‹é…ç½®è®¿é—®é¦–é¡µ
    4. ç›´æ¥è¾“å…¥`http://localhost:8080/xr/`å°±ä¼šè·³è½¬åˆ°ä¸ªäººç®€å†é¡µé¢
    5. æœ¬è´¨æ˜¯æ‰§è¡Œ`http://localhost:8080/xr/user/front`
    
    ```
    <!-- é…ç½®é¦–é¡µ -->
    <welcome-file-list>
        <welcome-file>user/front</welcome-file>
    </welcome-file-list>
    ```
3. ä¸ªäººç®€å†é¡µé¢UserServletä»£ç å¦‚ä¸‹
    
    ```
    private SkillService skillService = new SkillServiceImpl();
    private AwardService awardService = new AwardServiceImpl();
    private WebsiteService websiteService = new WebsiteServiceImpl();

    /*
    å¯¹http://localhost:8080/xr/è¯·æ±‚åšç‰¹æ®Šå¤„ç†
    ä¸Šé¢è®²è¿‡ï¼Œè°ƒç”¨æ ¹è·¯å¾„æœ¬è´¨æ˜¯è®¿é—®http://localhost:8080/xr/user/frontï¼Œå› æ­¤ä¼šæ¥åˆ°UserServletï¼Œä½†æ˜¯æ­¤æ—¶çš„å®é™…è·¯å¾„ä»ç„¶æ˜¯http://localhost:8080/xr/
    é‚£ä¹ˆç»è¿‡BaseServletçš„doGetåˆ‡å‰²åï¼Œè°ƒç”¨çš„æ˜¯xræ–¹æ³•ï¼Œå¾ˆæ˜¾ç„¶æ²¡æœ‰è¯¥æ–¹æ³•ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡å†™çˆ¶ç±»çš„doGetï¼Œä¸“é—¨å¤„ç†
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        String uri = request.getRequestURI();
        //é€šè¿‡/åˆ‡å‰²
        String[] cmps = uri.split("/");
        //æ‹¿åˆ°æœ€åä¸€ä¸ªè®¿é—®è·¯å¾„å
        String methodName = "/" + cmps[cmps.length - 1];
        //1. å¦‚æœä¸ºæ ¹è·¯å¾„/xrï¼Œåˆ™å°±æ˜¯è®¿é—®ä¸ªäººç®€å†é¡µé¢
        if (methodName.equals(request.getContextPath())) {
            try {
                front(request, response);
            } catch (Exception e) {
                e.printStackTrace();
            }
        //2. å¦åˆ™è®¿é—®çˆ¶ç±»çš„dogetæ–¹æ³•
        } else {
            super.doGet(request, response);
        }
    }
    //ä¸ªäººç®€å†é¡µé¢
    public void front(HttpServletRequest request, HttpServletResponse response) throws Exception {
        //è·å–ä¸ªäººç®€å†é¡µé¢éœ€è¦å±•ç¤ºçš„æ•°æ®ä¿¡æ¯
        // ç”¨æˆ·ä¿¡æ¯
        User user = service.list().get(0);
        request.setAttribute("user", user);

        // ä¸ªäººç‰¹è´¨
        request.setAttribute("trait", user.getTrait().split(","));

        // å…´è¶£çˆ±å¥½
        request.setAttribute("interests", user.getInterests().split(","));

        // ä¸“ä¸šæŠ€èƒ½
        request.setAttribute("skills", skillService.list());
        // è·å¥–æˆå°±
        request.setAttribute("awards", awardService.list());
        // ç½‘ç«™çš„åº•éƒ¨ä¿¡æ¯
        request.setAttribute("footer", websiteService.list().get(0).getFooter());
        //è½¬å‘åˆ°ä¸ªäººç®€å†é¡µé¢
        forward(request, response, "front/user.jsp");
    }
    ```
  
### ä¸ªäººç®€å†å³ä¾§çš„å¯¼èˆªæ å¯¹åº”çš„é¡µé¢  
1. æ ¹æ®ä¸ªäººç®€å†é¡µé¢å³è¾¹çš„å¯¼èˆªæ ï¼Œéœ€è¦è®¿é—®æ•™è‚²ç»éªŒã€å·¥ä½œç»éªŒã€é¡¹ç›®ç»éªŒç­‰ç®€å†æ¨¡å—é¡µé¢ï¼ˆæ³¨æ„ï¼Œè·Ÿç®¡ç†ç«¯ä¸ä¸€æ ·ï¼‰
2. å¯¼èˆªjspä¸­è®¿é—®å¦‚ä¸‹
        
    ```
    <li><a href="${ctx}/education/front" data-tooltip="æ•™è‚²ç»éªŒ"><span 
    class="crt-icon crt-icon-book"></span></a></li>
    <li><a href="${ctx}/experience/front" data-tooltip="å·¥ä½œç»éªŒ"><span 
    class="crt-icon crt-icon-experience"></span></a></li>
    <li><a href="${ctx}/project/front" data-tooltip="é¡¹ç›®ç»éªŒ"><span 
    class="crt-icon crt-icon-wrench"></span></a></li>
    <li><a href="${ctx}/contact/front" data-tooltip="è”ç³»æˆ‘å§"><span 
    class="crt-icon crt-icon-contact"></span></a></li>
    <li><a href="${ctx}/user/admin" data-tooltip="åå°ç®¡ç†"><span
    class="crt-icon crt-icon-key"></span></a></li>
    ```
3. å› æ­¤éœ€è¦åˆ†åˆ«åœ¨EducationServlet/ExperienceServlet/ProjectServletä¸­æ·»åŠ ç›¸åº”çš„æ¥å£æ–¹æ³•ï¼Œä¾‹å¦‚é¡¹ç›®ç»éªŒ
       
    ```
    //ProjectServletä¸­æ·»åŠ è®¿é—®å·¥ä½œç»éªŒ
    private UserService userService = new UserServiceImpl();
    private WebsiteService websiteService = new WebsiteServiceImpl();

    public void front(HttpServletRequest request, HttpServletResponse response) throws Exception {
        request.setAttribute("user", userService.list().get(0));
        request.setAttribute("footer", websiteService.list().get(0).getFooter());
        request.setAttribute("projects", service.list());
        forward(request, response, "front/project.jsp");
    }
    ```
    
## ç•™è¨€ä¿¡æ¯åŠŸèƒ½
1. åŒç†æ–°å¢ç•™è¨€ä¿¡æ¯æ¨¡å—çš„beanã€daoã€serviceã€servletä»¥åŠå¯¹åº”çš„ä¸ªäººç®€å†é¡µé¢çš„jspã€åå°ç®¡ç†é¡µé¢çš„jsp

### å¤šæ¡ä»¶æŸ¥è¯¢ã€åˆ†é¡µæ•°æ®
1. å¤šæ¡ä»¶:æ ¹æ®æ˜¯å¦å·²è¯»ã€æ—¥æœŸã€ä¸»é¢˜ã€å†…å®¹å¯ä»¥è¿›è¡Œå¤šæ¡ä»¶æŸ¥è¯¢
2. åˆ†é¡µå±•ç¤ºï¼šå½“æ•°æ®äº†å¤§çš„æ—¶å€™åˆ†é¡µå±•ç¤ºæ•°æ®ç»™å‰ç«¯
3. å‰ç«¯éœ€è¦å°†ä¸€äº›æ¡ä»¶å‘é€ç»™æœåŠ¡å™¨ï¼š
    1. é¡µç ï¼šè¦å±•ç¤ºç¬¬å‡ é¡µæ•°æ®
    2. æ¯é¡µå¤§å°ï¼šæ¯ä¸€é¡µå±•ç¤º20æ¡
    3. å¼€å§‹æ—¶é—´
    4. ç»“æŸæ—¶é—´
    5. å…³é”®å­—
    6. é˜…è¯»çŠ¶æ€

### ä»£ç ç¤ºä¾‹
1. æ–°å»ºä¸€ä¸ªbean(ContactListParam)ç”¨äºæ¥æ”¶å‰ç«¯çš„æŸ¥è¯¢å‚æ•°
    
    ```
    package com.zh.xr.bean;
    import java.util.Date;
    public class ContactListParam {
        public static final int READ_ALL = 2;
        private Integer pageNo;
        private Integer pageSize;
        private Date beginDay;
        private Date endDay;
        private String keyword;
        /** 0ï¼šæœªè¯» 1ï¼šå·²è¯» 2ï¼šå…¨éƒ¨ */
        private Integer alreadyRead;
        //æ‰€æœ‰å±æ€§çš„getæ–¹æ³•ã€setæ–¹æ³•...
    }
    ```
2. æœåŠ¡å™¨è¿”å›çš„æ•°æ®ä¹Ÿä¸èƒ½æ˜¯Contactæ¨¡å‹çš„åˆ—è¡¨äº†ï¼Œå› æ­¤æ–°å»ºä¸€ä¸ªè¿”å›ç»“æœçš„beanï¼ˆContactListResultï¼‰
    
    ```
    package com.zh.xr.bean;
    import java.util.List;
    public class ContactListResult extends ContactListParam {
        /**
         * æ€»æ•°é‡
         */
        private Integer totalCount;
        /**
         * æ€»é¡µæ•°
         */
        private Integer totalPages;
        private List<Contact> contacts;
        //æ‰€æœ‰å±æ€§çš„getæ–¹æ³•ã€setæ–¹æ³•...
    }
    ```
3. daoæ¨¡å—çš„ä»£ç ï¼ˆ**é‡è¦**ï¼‰
    1. daoæ¥å£
        
        ```
        public interface ContactDao extends BaseDao<Contact> {
            ContactListResult list(ContactListParam param);
            boolean read(Integer id);
        }
        ```
    2. daoå®ç°
        
        ```
       public class ContactDaoImpl extends BaseDaoImpl<Contact> implements ContactDao {
            @Override
            public boolean save(Contact bean) {
                Integer id = bean.getId();
                List<Object> args = new ArrayList<>();
                args.add(bean.getName());
                args.add(bean.getEmail());
                args.add(bean.getComment());
                args.add(bean.getSubject());
                args.add(bean.getAlreadyRead());
        
                String sql;
                if (id == null || id < 1) { // æ·»åŠ 
                    sql = "INSERT INTO contact(name, email, comment, subject, already_read) VALUES(?, ?, ?, ?, ?)";
                } else {
                    sql = "UPDATE contact SET name = ?, email = ?, comment = ?, subject = ?, already_read = ? WHERE id = ?";
                    args.add(id);
                }
                return tpl.update(sql, args.toArray()) > 0;
            }
        
            @Override
            public Contact get(Integer id) {
                String sql = "SELECT id, created_time, name, email, comment, subject, already_read FROM contact WHERE id = ?";
                return tpl.queryForObject(sql, new BeanPropertyRowMapper<>(Contact.class), id);
            }
        
            @Override
            public List<Contact> list() {
                String sql = "SELECT id, created_time, name, email, comment, subject, already_read FROM contact";
                return tpl.query(sql, new BeanPropertyRowMapper<>(Contact.class));
            }
        
            @Override
            public ContactListResult list(ContactListParam param) {
                ContactListResult result = new ContactListResult();
        
                StringBuilder sql = new StringBuilder();
                sql.append("SELECT id, created_time, name, email, comment, subject, already_read FROM contact WHERE 1 = 1 ");
        
                // å‚æ•°
                List<Object> args = new ArrayList<>();
        
                // æ¡ä»¶
                StringBuilder condition = new StringBuilder();
        
                if (param.getBeginDay() != null) { // å¼€å§‹æ—¶é—´
                    condition.append("AND created_time >= ? ");
                    args.add(param.getBeginDay());
                    result.setBeginDay(param.getBeginDay());
                }
        
                if (param.getEndDay() != null) { // ç»“æŸæ—¶é—´
                    condition.append("AND created_time <= ? ");
                    args.add(param.getEndDay());
                    result.setEndDay(param.getEndDay());
                }
        
                String keyword = param.getKeyword();
                if (keyword != null && keyword.length() > 0) { // å…³é”®å­—
                    result.setKeyword(keyword);
                    condition.append("AND (name LIKE ? OR email LIKE ? OR subject LIKE ? OR comment LIKE ?) ");
                    keyword = "%" + keyword + "%";
                    args.add(keyword);
                    args.add(keyword);
                    args.add(keyword);
                    args.add(keyword);
                }
        
                Integer read = param.getAlreadyRead();
                if (read != null && read < ContactListParam.READ_ALL) { // é˜…è¯»çŠ¶æ€
                    condition.append("AND already_read = ? ");
                    args.add(read);
                    result.setAlreadyRead(read);
                }
        
                // æ€»æ•°é‡ã€æ€»é¡µæ•°
                Integer pageSize = param.getPageSize();
                if (pageSize == null || pageSize < 10) {
                    pageSize = 10;
                }
        
                /*
                æ€»æ•°é‡ï¼š101
                æ¯ä¸€é¡µæ˜¾ç¤º20æ¡
                æ€»é¡µæ•° = (æ€»æ•°é‡ + æ¯é¡µçš„æ•°é‡ - 1) / æ¯é¡µçš„æ•°é‡
                 */
                String countSql = "SELECT COUNT(*) FROM contact WHERE 1 = 1 " + condition;
                Integer totalCount = tpl.queryForObject(countSql, Integer.class, args.toArray());
                if (totalCount == 0) return result;
        
                int totalPages = (totalCount + pageSize - 1) / pageSize;
                result.setTotalPages(totalPages); // 2
                result.setTotalCount(totalCount);
        
                // åˆ†é¡µ
                sql.append(condition);
                sql.append("LIMIT ?, ?");
                Integer pageNo = param.getPageNo(); // 9
                if (pageNo == null || pageNo < 1) {
                    pageNo = 1;
                } else if (pageNo > totalPages) { // é¡µç å¦‚æœå·²ç»è¶…è¿‡äº†æ€»é¡µæ•°
                    pageNo = totalPages;
                }
                args.add((pageNo - 1) * pageSize);
                args.add(pageSize);
                result.setPageNo(pageNo);
                result.setPageSize(pageSize);
        
                List<Contact> contacts = tpl.query(sql.toString(), new BeanPropertyRowMapper<>(Contact.class), args.toArray());
                result.setContacts(contacts);
        
                return result;
            }
        
            @Override
            public boolean read(Integer id) {
                String sql = "UPDATE contact SET already_read = 1 WHERE id = ?";
                return tpl.update(sql, id) > 0;
            }
        }
        ```
    3. serviceå®ç°
        1. æ¥å£
        
            ```
            public interface ContactService extends BaseService<Contact> {
                ContactListResult list(ContactListParam param);
                boolean read(Integer id);
            }
            ```
        2. å®ç°
            
            ```
            public class ContactServiceImpl extends BaseServiceImpl<Contact> implements ContactService {
                @Override
                public ContactListResult list(ContactListParam param) {
                    return ((ContactDao) dao).list(param);
                }
                @Override
                public boolean read(Integer id) {
                    return ((ContactDao) dao).read(id);
                }
            }
            ```
    4. Servlet
        
        ```
        @WebServlet("/contact/*")
        public class ContactServlet extends BaseServlet<Contact> {
            private UserService userService = new UserServiceImpl();
            private WebsiteService websiteService = new WebsiteServiceImpl();
        
            //ä¸ªäººç®€å†é¡µé¢å±•ç¤ºç•™è¨€ä¿¡æ¯é¡µé¢
            public void front(HttpServletRequest request, HttpServletResponse response) throws Exception {
                request.setAttribute("user", userService.list().get(0));
                request.setAttribute("footer", websiteService.list().get(0).getFooter());
                // è½¬å‘
                forward(request, response, "front/contact.jsp");
            }
        
            //åå°ç®¡ç†é¡µé¢å±•ç¤ºç•™è¨€ä¿¡æ¯é¡µé¢
            public void admin(HttpServletRequest request, HttpServletResponse response) throws Exception {
                //æŸ¥è¯¢æ¡ä»¶
                ContactListParam param = new ContactListParam();
                BeanUtils.populate(param, request.getParameterMap());
        
                request.setAttribute("result", ((ContactService) service).list(param));
                forward(request, response, "admin/contact.jsp");
            }
            //ä¸ªäººç®€å†é¡µé¢ä¿å­˜ç•™è¨€ä¿¡æ¯é¡µé¢
            public void save(HttpServletRequest request, HttpServletResponse response) throws Exception {
                // æ£€æŸ¥éªŒè¯ç 
                String code = (String) request.getSession().getAttribute("code");
                String captcha = request.getParameter("captcha");
                if (!code.equals(captcha)) {
                    forwardError(request, response, "éªŒè¯ç é”™è¯¯");
                    return;
                }
        
                Contact contact = new Contact();
                BeanUtils.populate(contact, request.getParameterMap());
                if (service.save(contact)) { // ä¿å­˜æˆåŠŸ
                    redirect(request, response, "contact/front");
                } else {
                    forwardError(request, response, "ç•™è¨€ä¿¡æ¯ä¿å­˜å¤±è´¥");
                }
            }
        
            //åå°ç®¡ç†ç«¯ï¼Œç‚¹å‡»æŸ¥çœ‹ç•™è¨€æ•°æ®ï¼Œéœ€è¦æ”¹å˜è¿™æ¡ç•™è¨€çš„çŠ¶æ€
            public void read(HttpServletRequest request, HttpServletResponse response) throws Exception {
                Integer id = Integer.valueOf(request.getParameter("id"));
        
                Map<String, Object> result = new HashMap<>();
                if (((ContactService) service).read(id)) {
                    result.put("success", true);
                    result.put("msg", "æŸ¥çœ‹æˆåŠŸ");
                } else {
                    result.put("success", false);
                    result.put("msg", "æŸ¥çœ‹å¤±è´¥");
                }
        
                response.setContentType("text/json; charset=UTF-8");
                response.getWriter().write(new ObjectMapper().writeValueAsString(result));
            }
        
            public void remove(HttpServletRequest request, HttpServletResponse response) throws Exception {
        
            }
        }
        ```

