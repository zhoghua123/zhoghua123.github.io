---
layout: post
title: 项目实战四-前后端分离驾考项目（三）
category: Java后端开发
tags: Java后端开发
description: Java后端开发
---  

## 前后端分离驾考项目

### 省份、城市模块
1. 经分析省份跟城市可以放在一张表中，因此将之前的做的省份模板删除：po、service、query、controller层，都删了
2. 省份与城市共同的表叫做plate_region
    
    ```
    //省份、城市放在同一张表格，城市的parent_id指向省份的id
    id  name    plate       pingyin     parent_id
    3   广东      粤       GUANG_DONG      0
    4   福建      闽       FU_JIAN         0
    5   广州      A        guangzhou       3
    ```
3. 通过EasyCode-MybatisCodeHepler生成对应层的类
    1. 生成的类有po(PlateRegion)、mapper(PlateRegionController)、service(PlateRegionService/PlateRegionServiceImpl)、controller(PlateRegionController)
4. 各层的代码示例
    1. PlateRegion
        
        ```
        //com.zh.jk.pojo.po
        @Data
        public class PlateRegion {
            /**
            * 主键
            */
            private Integer id;
            /**
            * 名称
            */
            private String name;
            /**
            * 车牌
            */
            private String plate;
            /**
            * 拼音
            */
            private String pinyin;
            
            private Integer parentId;
        }
        ```
    2. query
        
        ```
        //com.zh.jk.pojo.query
        //CityQuery
        @EqualsAndHashCode(callSuper = true)
        @Data
        public class CityQuery extends KeywordQuery {
            /**
             * 省份id
             */
            private Integer parentId;
        }
        //ProvinceQuery
        public class ProvinceQuery extends KeywordQuery {}
        ```
    3. mapper
        
        ```
        //com.zh.jk.mapper
        public interface PlateRegionMapper extends BaseMapper<PlateRegion> {}
        ```
    4. service
        
        ```
        //com.zh.jk.service
        //PlateRegionService
        public interface PlateRegionService extends IService<PlateRegion> {
            //分页查询所有省份
            void listProvinces(ProvinceQuery query);
            //分页查询所有城市
            void listCities(CityQuery query);
            //不分页查询所有省份
            List<PlateRegion> listProvinces();
        }
        ////com.zh.jk.service.impl
        //PlateRegionServiceImpl
        @Service
        @Transactional
        public class PlateRegionServiceImpl extends ServiceImpl<PlateRegionMapper, PlateRegion> implements PlateRegionService {       
            @Override
            @Transactional(readOnly = true)
            public void listProvinces(ProvinceQuery query) {
                MpQueryWrapper<PlateRegion> wrapper = new MpQueryWrapper<>();
                wrapper.like(query.getKeyword(),
                        PlateRegion::getName,
                        PlateRegion::getPlate,
                        PlateRegion::getPinyin);
                //查询所有的省份，getParentId都是0的，都是省份
                wrapper.eq(PlateRegion::getParentId,0);
                wrapper.orderByDesc(PlateRegion::getId);
                baseMapper.selectPage(new MpPage<>(query),wrapper).updateQuery();
        
            }
        
            @Override
            @Transactional(readOnly = true)
            public void listCities(CityQuery query) {
                MpQueryWrapper<PlateRegion> wrapper = new MpQueryWrapper<>();
                wrapper.like(query.getKeyword(),
                        PlateRegion::getName,
                        PlateRegion::getPlate,
                        PlateRegion::getPinyin);
                Integer provinceId = query.getParentId();
                if (provinceId != null && provinceId >0 ){
                    //查询指定省份的城市
                    wrapper.eq(PlateRegion::getParentId,provinceId);
                }else {
                    //查询所有省份的城市，getParentId ！= 0
                    wrapper.ne(PlateRegion::getParentId,0);
                }
                wrapper.orderByDesc(PlateRegion::getId);
                baseMapper.selectPage(new MpPage<>(query),wrapper).updateQuery();
            }
        
            @Override
            @Transactional(readOnly = true)
            public List<PlateRegion> listProvinces() {
                MpQueryWrapper<PlateRegion> wrapper = new MpQueryWrapper<>();
                wrapper.eq(PlateRegion::getParentId,0);
                wrapper.orderByDesc(PlateRegion::getPinyin);
                return baseMapper.selectList(wrapper);
            }
        }
        ```
    
#### 问题：如何实现拼音保存？
1. 编辑一个省份信息时，保存的只有省份名称、车牌，并没有保存省份的拼音，那么数据库中pinyin字段肯定是空值，那么也就无法实现拼音的搜索
    
    ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-42.png)
2. 查询BaseController中的save方法
    
    ```
    @PostMapping("/save")
    public R save(T entity){
        if ( getService().saveOrUpdate(entity)){
            return Rs.ok("保存成功");
        }else {
            throw new CommonException("保存失败");
        }
    }
    ```
    
    1. 点击saveOrUpdate进入查看源码,找到IService.class中，此时无法找到该方法（saveOrUpdate）的实现
    2. **重要！！！**通过快捷键`ctrl/command+alt+B`,可以自动跳转到一个方法的实现,通过查看saveOrUpdate方法的实现：
    3. 跳转到ServiceImpl.class
        
        ```
        public boolean saveOrUpdate(T entity) {
            if (null == entity) {
                return false;
            } else {
                ...
                return !StringUtils.checkValNull(idVal) && !Objects.isNull(this.getById((Serializable)idVal)) ? this.updateById(entity) : this.save(entity);
            }
        }
        ```
    4. 可以看到本质是调用了this.updateById、this.save，这两个方法
    5. 而且PlateRegionServiceImpl类是继承了ServiceImpl这个类，因此可以想到在子类中重写这2个方法
3. 改造PlateRegionServiceImpl类
    1. 在PlateRegionServiceImpl方法中重写父类的save、updateById如下
        
        ```
        //重写父类方法，手动实现拼音的存储，到数据库
        @Override
        public boolean save(PlateRegion entity) {
            //手动处理将汉字转为拼音，然后赋值给PlateRegion的pinyin属性
            processPinyin(entity);
            return super.save(entity);
        }
    
        @Override
        public boolean updateById(PlateRegion entity) {
            //手动处理将汉字转为拼音，然后赋值给PlateRegion的pinyin属性
            processPinyin(entity);
            return super.updateById(entity);
        }
        ```
    2. 如何实现汉字转拼音呢？
        1. pom.xml添加依赖tinypinyin
            
            ```
            <!-- 将汉字转为拼音-->
            <dependency>
                <groupId>com.github.promeg</groupId>
                <artifactId>tinypinyin</artifactId>
                <version>${tinypinyin.version}</version>
            </dependency>
            ```
        2. PlateRegionServiceImpl封装方法
            
            ```
            private void processPinyin(PlateRegion region) {
                String name = region.getName();
                if (name == null) return;
                //将汉字转为拼音
                //使用第三方库，tinypinyin
                //guang_dong
                region.setPinyin(Pinyin.toPinyin(name,"_"));
            }
            ```

