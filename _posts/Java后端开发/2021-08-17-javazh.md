---
layout: post
title: 项目实战五-前后端分离驾考项目（四）
category: Java后端开发
tags: Java后端开发
description: Java后端开发
---  

## 前后端分离驾考项目

### 考场模块
1. 考场页面列表展示功能
2. 通过EasyCode-MybatisCodeHepler生成对应层的类,exam_place表
3. 各个层代码如下；
    1. po
        
        ```
        @Data
        public class ExamPlace {
            /**
            * 主键
            */
            private Integer id;
            /**
            * 名称
            */
            private String name;
            /**
            * 考场是哪个省份的
            */
            @ForeignField(PlateRegion.class)
            private Integer provinceId;
            /**
            * 考场是哪个城市的
            */
            @ForeignField(PlateRegion.class)
            private Integer cityId;
            /**
            * 考场的具体地址
            */
            private String address;
            /**
            * 纬度
            */
            private Double latitude;
            /**
            * 经度
            */
            private Double longitude;
        }
        ```
    2. query
        
        ```
        @EqualsAndHashCode(callSuper = true)
        @Data
        public class ExamPlaceQuery extends KeywordQuery {
            private Integer provinceId;
            private Integer cityId;
        }
        ```
    3. mapper
        
        ```
        public interface ExamPlaceMapper extends BaseMapper<ExamPlace> {}
        ```
    4. service
        
        ```
        //ExamPlaceService
        public interface ExamPlaceService extends IService<ExamPlace> {
            void list(ExamPlaceQuery query);
        }
        //ExamPlaceServiceImpl
        @Service
        @Transactional
        public class ExamPlaceServiceImpl extends ServiceImpl<ExamPlaceMapper, ExamPlace> implements ExamPlaceService {
        
            @Override
            @Transactional(readOnly = true)
            public void list(ExamPlaceQuery query) {
                //查询条件
                MpQueryWrapper<ExamPlace> wrapper = new MpQueryWrapper<>();
                wrapper.like(query.getKeyword(),ExamPlace::getName,ExamPlace::getAddress);
                //城市
                Integer cityId = query.getCityId();
                Integer provinceId = query.getProvinceId();
                if (cityId != null && cityId > 0) {
                    wrapper.eq(ExamPlace::getCityId,cityId);
                }else if (provinceId != null && provinceId > 0) {
                    wrapper.eq(ExamPlace::getProvinceId,provinceId);
                }
                //排序方式
                wrapper.orderByDesc(ExamPlace::getId);
                //查询
                baseMapper.selectPage(new MpPage<>(query),wrapper).updateQuery();
            }
        }
        ```
    5. controller
        
        ```
        @RestController
        @RequestMapping("/examPlaces")
        public class ExamPlaceController extends BaseController<ExamPlace> {
            @Autowired
            private ExamPlaceService service;
        
            @Override
            protected IService<ExamPlace> getService() {
                return service;
            }
            @GetMapping
            public R list(ExamPlaceQuery query) {
                service.list(query);
                return Rs.ok(query);
            }
        }
        ```

#### 二级联动
1. 在考场页面中有二级联动搜索，如下图
    
    ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-43.png)
2. 如果要实现二级联动，那么后台返回的数据格式应该如下
    
    ```
        {
        "code": 0,
        "data": [
            {
                "id": 3,
                "name": "广东",
                "plate": "粤",
                "children": [
                    {
                        "id": 5,
                        "name": "广州",
                        "plate": "A"
                    },
                    {
                        "id": 14,
                        "name": "汕头",
                        "plate": "D"
                    }
                ]
            },
            {
                "id": 4,
                "name": "福建",
                "plate": "闽",
                "children": [
                    {
                        "id": 16,
                        "name": "厦门",
                        "plate": "J"
                    },
                    {
                        "id": 15,
                        "name": "福州",
                        "plate": "A"
                    },
                    {
                        "id": 17,
                        "name": "莆田",
                        "plate": "B"
                    }
                ]
            }
        ]
    }
    ```
3. 分析：
    1. 这是一个树状结构的数据，但是目前po中的PlateRegion类并不是这样的结构模型，直接按照这个修改？
    2. 如果修改就破坏了po与数据库表的一致性,因此就**出现了dto层**
    3. 在pojo下新建dto包，下面新建数据模型类
        
        ```
        //com.zh.jk.pojo.dto
        @Data
        public class ProvinceDto {
            private Integer id;
            private String name;
            private String plate;
            private List<CityDto> children;
        }
        @Data
        public class CityDto {
            private Integer id;
            private String name;
            private String plate;
        }
        ```
4. controller改造
    1. 由于该接口请求的是省份、城市，因此在PlateRegionController中新增接口
        
        ```
        /*
        * 返回所有的省份+城市，树状结构
        * */
        @GetMapping("/regions")
        public R listRegions(){
            return Rs.ok(service.listRegions());
        }
        ```
5. service新增方法
    
    ```
    //PlateRegionService
    List<ProvinceDto> listRegions();
    //PlateRegionServiceImpl
    @Override
    public List<ProvinceDto> listRegions() {
        return baseMapper.selectRegions();
    }
    ```
    
    1. **注意：** baseMapper是BaseMapper类，但是该类并没有selectRegions方法，该方法是自定义的，因此需要在BaseMapper类的基础上新增方法
6. mapper层，PlateRegionMapper新增方法
    1. PlateRegionMapper仅仅是一个接口interface，那么如何新增方法实现呢？---**通过xml**
    2. PlateRegionMapper新增自定义方法
        
        ```
        public interface PlateRegionMapper extends BaseMapper<PlateRegion> {
            List<ProvinceDto> selectRegions();
        }
        ```
    3. 在resources下新建**与PlateRegionMapper相同的包名相同的类名的xml文件**，如下
        
        ```
        <!--resources.com.zh.jk.mapper.PlateRegionMapper.xml-->
        <?xml version="1.0" encoding="UTF-8" ?>
        <!DOCTYPE mapper
                PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
                "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        <mapper namespace="com.zh.jk.mapper.PlateRegionMapper">
            <resultMap id="rmSelectRegions"
                       type="ProvinceDto">
                <id column="id" property="id"/>
                <result column="name" property="name"/>
                <result column="plate" property="plate"/>
                <collection property="children" ofType="CityDto">
                    <id column="city_id" property="id"/>
                    <result column="city_name" property="name"/>
                    <result column="city_plate" property="plate"/>
                </collection>
            </resultMap>
        
            <!-- 使用了数据库的交集、并集等集合方式 -->
            <select id="selectRegions"
                    resultMap="rmSelectRegions">
                SELECT
                    p.id,
                    p.name,
                    p.plate,
                    c.id city_id,
                    c.name city_name,
                    c.plate city_plate
                FROM plate_region p
                     JOIN plate_region c ON c.parent_id = p.id
                WHERE p.parent_id = 0
                ORDER BY p.pinyin, c.plate
            </select>
        </mapper>
        ```
        
        


