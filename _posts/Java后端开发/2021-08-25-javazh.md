---
layout: post
title: 项目实战九-前后端分离驾考项目（八）
category: Java后端开发
tags: Java后端开发
description: Java后端开发
--- 

## 登录功能
> 登录有：用户名、密码、验证码

1. 新增登录的vo
    1. 登录请求LoginReqVo：在req下直接添加
        
        ```
        @Data
        public class LoginReqVo {
            //用户名
            @NotBlank
            private String username;
        
            //密码
            @NotBlank
            private String password;
        
            //验证码
            @NotBlank
            private String captcha;
        }
        ```
    2. 登录响应LoginVo:在vo下直接添加
        
        ```
        @Data
        public class LoginVo {
            private Integer id;
            private String nickname;
            private String username;
            private String token;
        }
        ```
2. controller层
    1. 新增登录、获取验证码方法
        
        ```
        @PostMapping("/login")
        public DataJsonVo<LoginVo> login(LoginReqVo reqVo, HttpServletRequest request) {
            //验证验证码是否正确
            if (CaptchaUtil.ver(reqVo.getCaptcha(),request)){
                return JsonVos.ok(service.login(reqVo));
            }
            //验证码错误
            return JsonVos.raise(CodeMsg.WRONG_CAPTCHA);
    
        }
    
        //生成验证码
        @GetMapping("/captcha")
        public void captcha(HttpServletRequest request,
                            HttpServletResponse response) throws Exception {
    
            //返回给前端的事验证码图片,CaptchaUtil是使用功能第三方jar包easy-captcha
            CaptchaUtil.out(request, response);
        }
        ```
    2. **注意：**
        1. 给前端体用验证码接口，使用第三方jar包easy-captcha，pom.xml中导入
            
            ```
            <!-- 验证码 -->
            <dependency>
                <groupId>com.github.whvcse</groupId>
                <artifactId>easy-captcha</artifactId>
                <version>1.6.2</version>
            </dependency>
            ```
        2. 前端必须要传递cookie到后台，才能正确识别验证码，后台要允许跨域以及允许传递cookie
            1. 后台：目前在WebCfg类中已经全局配置
                
                ```
                allowCredentials(true)
                allowedOrigins(origins): 要指定特定的主机地址，不能使用*
                ```
            2. 前端
            
                ```
                Ajaxs.loadPost({
                    uri: 'sysUsers/login',
                    data: data.field,
                    success: (response) => {
                        //登录成功跳转到首页
                        location.href = '../index.html'
                    },
                    //必须要加这个，需要跨域带上cookie
                    xhrFields: { 
                        withCredentials: true
                    }
                })
                ```
3. service层

    ```
    //新增接口
    LoginVo login(LoginReqVo reqVo);
    
    //impl新增方法实现
    @Override
    public LoginVo login(LoginReqVo reqVo) {
        //根据用户名查询用户
        MpLambdaQueryWrapper<SysUser> wrapper = new MpLambdaQueryWrapper<>();
        wrapper.eq(SysUser::getUsername,reqVo.getUsername());
        SysUser po = baseMapper.selectOne(wrapper);
        if (po == null) { //用户名不存在
            return JsonVos.raise(CodeMsg.WRONG_USERNAME);
        }
        //密码不正确
        if (!po.getPassword().equals(reqVo.getPassword())){
            return JsonVos.raise(CodeMsg.WRONG_PASSWORD);
        }
        //账号锁定
        if(po.getStatus() == 1){
            return JsonVos.raise(CodeMsg.USER_LOCKED);
        }
        //更新登录时间
        po.setLoginTime(new Date());
        baseMapper.updateById(po);
        
        return MapStructs.INSTANCE.po2loginVo(po);
    }
    ```
    
    1. 注意：MapStructs需要添加LoginVo-》SysUser转化
        
        ```
        LoginVo po2loginVo(SysUser po);
        ```
    
    


