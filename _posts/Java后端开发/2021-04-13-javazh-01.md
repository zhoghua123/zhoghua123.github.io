---
layout: post
title: JavaEE开发-第二节 MySQL
category: Java后端开发
tags: Java后端开发
description: Java后端开发
--- 

### 如何通过Java操作数据库？
1. JDBC,全称是Java Datbase Connectivity
    1. 在Java中用来规范如何访问关系型数据库，由各大数据库厂商去实现它
    2. 属于JavaSE的一部分
    3. 简单来说就是一套接口规范，定义了一些访问数据库的接口标准
    4. 各大厂商需要实现这些接口标准
    5. JDBC是JDK的一部分，只要安装了JDK,就有JDBC
2. 调用方式
    1. java开发人员，使用JDBC接口，调用各大厂商的数据库
    
    ![图1](https://raw.githubusercontent.com/zhoghua123/imgsBed/master/javazh-21.png)

#### 下载MySQL的JDBC实现（jar，驱动包）
1. 8.0版本的驱动包同时支持MySQL 5.7/8.0
    1. [https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-versions.html](https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-versions.html)
2. 下载地址
    1. [https://dev.mysql.com/downloads/connector/j/](https://dev.mysql.com/downloads/connector/j/)
    2. 进入后点击Archive,选择版本号，Operating System选择Platmform Independent 然后点击`(mysql-connector-java-8.0.21.zip)`Download，即可
3. 将jar包导入
    1. 复制jar包到lib目录下
    2. 右击jar包->添加为库->选择模块库 ->点击确定
    
### JDBC使用步骤
1. 将Driver (驱动程序) 注册到DriverManager (驱动程序管理者)
    1. Driver指的是各大数据库厂商实现的驱动，在上面下载的jar包的com.mysql.jdbc文件夹下有个Driver类
    2. DriverManager指的是JDBC实现的驱动程序管理者
2. 利用DriverManager创建Connection(数据库连接)
3. 利用Connection创建Statement(语句)
4. 利用Statement执行SQL语句
5. 关闭资源(关闭Statement、Connection等）


#### JDBC细节
1. MySQL的url格式是
    1. `jdbc:mysql://IP地址:端口号/数据库名`
    2. 比如:`jdbc:mysql://localhost:3306/zh`
2. 驱动类
    
    ```
              MySQL驱动包6.x以前           MySQL驱动包6.x开始
    驱动类     com.mysql.jdbc.Driver       com.mysql.cj.jdbc.Driver
    时区                                  需要指定一个确定的时区
                                         比如在url后加上参数serverTimezone=UTC                        
    ```
3. 6.x以后代码举例：
    
    ```
    Class.forName("com.mysql.cj.jdbc.Driver");
    DriverManager.getConnection("jdbc:mysql://localhost:3306/zh_info?serverTimezone=UTC","root","root");
    ```
    
#### 代码举例

```
package com.zh;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.Statement;

public class Main {
    public static void main(String[] args) throws Exception {
        //1. 注册Driver到DriverManager
        //DriverManager.registerDriver(new Driver());
        //装载一个类，就是将这个Driver类装载进去，通过查看源代码，发现有个静态方法直接实现了上面的一句代码，因此下面这么写等价于上面
        //而且这么写的好处是不需要导入Driver类，即import com.mysql.jdbc.Driver;
        Class.forName("com.mysql.jdbc.Driver");
        //2. 利用DriverManager创建Connection(数据库连接)
        //url指的是mysql的服务器地址，但是注意协议是 jdbc:mysql:
        Connection connection =  DriverManager.getConnection("jdbc:mysql://localhost:3306/zh_info","root","root");
        //3. 利用Connection创建Statement(语句)
        Statement statement = connection.createStatement();
        //4. 利用Statement执行SQL语句
        //将id==1的学生年龄改为100
        statement.execute("UPDATE  student SET age = 100 WHERE  id =1");
        //5. 关闭资源(关闭Statement、Connection等）
        statement.close();
        connection.close();
    }
}
```

1. 为什么要使用`Class.forName("com.mysql.jdbc.Driver");`代替`DriverManager.registerDriver(new Driver());`?
    1. `Class.forName("com.mysql.jdbc.Driver");`的本质是装载一个类
    2. 查看mysql的驱动源码com.mysql.jdbc.Driver类的实现如下
        
        ```
        public class Driver extends NonRegisteringDriver implements java.sql.Driver {
            //
            // Register ourselves with the DriverManager
            //
            static {
                try {
                    java.sql.DriverManager.registerDriver(new Driver());
                } catch (SQLException E) {
                    throw new RuntimeException("Can't register driver!");
                }
            }
        
            /**
             * Construct a new driver and register it with DriverManager
             * @throws SQLExceptionif a database error occurs.
             */
            public Driver() throws SQLException {
                // Required for Class.forName().newInstance()
            }
        }
        ```
    3. 会发现有个static块，当Driver类被加载的时候会自动调用static中的代码，因此可以替换
    4. 还有一个好处，这么一些文件中就不需要导入Driver类，即`import com.mysql.jdbc.Driver;`,那么即使有换掉数据库，只需要把字符串换掉即可
    
    
### JDBC版本
1. 从JDBC 4.0开始， 显式注册驱动程序是可选的
    
    ```
    //显示注册
    DriverManager.registerDriver(new Driver());
    Class.forName("com.mysql.jdbc.Driver");
    ```
2. 我们只需要将供应商的Jar**放在类路径**中,然后DriverManager就可以自动检测并加载驱动程序
    1. 就是上面的第三方jar包引入步骤
3. JDBC版本
    1. JDBC 4.0包含在Java SE 6中
    2. JDBC 4.1包含在Java SE 7中
    3. JDBC 4.2包含在Java SE 8中
    4. JDBC 4.3包含在Java SE 9中
4. 这里说的是JDBC的版本，是嵌入在JDK中的代码，不是mysql等其他厂商的数据库版本
5. 即：从Java SE 7开始，就可以省略第一步注册Driver的代码了


### Statement

#### Statement的常用API
1. ResultSet executeQuery(String sql)
    1. 执行DQL语句
2. int executeUpdate(String sql)
    1. 执行DML、DDL语句
    2. 如果是DML语句,返回值代表影响的记录数量;如果数据库没有任何返回值,通常返回0

#### ResultSet 的常用API
1. boolean next()
    1. 让游标指向下一行。如果指向的这行有数据,就返回true,否则,返回false
2. XX getXX(int columnIndex) 、XX getXX(String columnLabel)
    1. 获取当前行(游标指向的那行) 某一列的数据
    2. columnIndex的数值从**1开始**
    3. XX指的是数据类型，比如int、double...
3. 代码举例
    
    ```
    package com.zh;
    import java.sql.Connection;
    import java.sql.DriverManager;
    import java.sql.ResultSet;
    import java.sql.Statement;
    
    public class Main {
        private static final String driverClassName = "com.mysql.jdbc.Driver";
        private static final String URL = "jdbc:mysql://localhost:3306/zh_info";
        private static final String USERNAME = "root";
        private static final String PASSWORD = "root";
    
    
        public static void main(String[] args) throws Exception {
            try(Connection connection =  DriverManager.getConnection(URL,USERNAME,PASSWORD);
                Statement statement = connection.createStatement()
            ){
                String sql = "SELECT * FROM student";
                ResultSet rs = statement.executeQuery(sql);
                rs.next();//第一条数据，让游标指向第一条记录
                //获取第一条数据的age值
                System.out.println(rs.getInt("age"));
                System.out.println(rs.getString("name"));
                //列的索引，对应的值，从1开始
                System.out.println(rs.getInt(2));
    
            }
        }
    }
    ```

#### PreparedStatement
1. PreparedStatement接口继承自Statement接口
2. 建议使用PreparedStatement替代Statement
3. PreparedStatement的优点
    1. 可以防止**SQL注入**
    2. 执行速度比Statement快
    3. 支持批量处理
4. 代码举例：
    
    ```
    private static void login(String username,String password) throws Exception {
        try(Connection connection =  DriverManager.getConnection(URL,USERNAME,PASSWORD);
            Statement statement = connection.createStatement()
        ){
            String sql = "SELECT * FROM user WHERE username = '" + username+"' AND password = '"+ password + "'";

            //SELECT * FROM user WHERE username = 'xxxx' AND password = '' OR '1' = '1'
            System.out.println(sql);

            ResultSet rs = statement.executeQuery(sql);
            if (rs.next()){
                System.out.println("登录成功");
            }else {
                System.out.println("登录失败");
            }

        }
    }
    
    //main函数
    //SQL注入
    String username = "xxxx";//真正的账号是zhangsan
    String password = "' OR '1' = '1";//真正的密码是123
    login(username,password);
    //结果是：登录成功
    ```
    
    1. 这么一些，那么拼接后的sql语句为：`SELECT * FROM user WHERE username = 'xxxx' AND password = '' OR '1' = '1'`,那么永远成立，因此怎么都登录成功
5. 使用PreparedStatement
    
    ```
    private static void login2(String username,String password) throws Exception {
        String sql = "SELECT * FROM user WHERE username = ? AND password = ?";
        try(Connection connection =  DriverManager.getConnection(URL,USERNAME,PASSWORD);
            PreparedStatement pstat =  connection.prepareStatement(sql);
            ) {
            //设置上面的那两个?占位
            pstat.setString(1,username);
            pstat.setString(2,password);
            ResultSet rs = pstat.executeQuery();
            if (rs.next()){
                System.out.println("登录成功");
            }else {
                System.out.println("登录失败");
            }
        }
    }
    //结果是登录失败
    ```
    
    1. 这么写会直接让?占位符的内容进行字符串转义，并不是直接拼接，防止注入

### 配置文件
1. 一些经常动态修改的值， 建议放入到配置文件中， 不要写死在Java代码中
2. Java中常见的配置文件
    1. properties：比较单一， 适合量小、简单的配置
    2. xml：比较灵活， 适合量大、复杂的配置
3. properties文件
    1. key、value的分隔符是=、：
    2. 建议分隔符左右不要留空格
    3. `#、!`开头是单行注释
    4. 可以用反斜线\连接多行内容


### 数据库连接池
1. 数据库连接池，可以提高访问数据库的性能，负责创建、分配、管理和释放数据库连接
2. 基本思想
    1. 在初始化时，创建一定数量的数据库连接对象存储在内存中
    2. 当需要访问数据库时，并非建立一个新的连接，而是从连接池中取出一个已创建的空闲连接对象
    3. 使用完毕后，用户也并非将连接关闭，而是将连接放回连接池中，以供下一个请求访问使用
    4. 当连接的空闲时间已超过最大空闲时间时，将会释放掉该连接
    5. 可以通过设置参数来控制初始连接数、连接的上下限数以及每个连接的最大使用次数、最大空闲时间
    6. 可以通过其自身的管理机制来监视数据库连接的数量、使用情况
3. Java中常见的开源的数据库连接池
    1. C3P0、Proxool、DBCP、BoneCP、Druid等
    
#### Druid
1. 产自阿里巴巴，项目地址：[https://github.com/alibaba/druid/](https://github.com/alibaba/druid/)
2. jar包下载：[https://mvnrepository.com/artifact/com.alibaba/druid](https://mvnrepository.com/artifact/com.alibaba/druid)

### Spring JDBC
1. Spring JDBC框架可以帮助开发者节省大量开发工作,自动去处理一些低级细节，比如
    1. 异常处理、打开和关闭资源(Connection、Statement、ResultSet)
2. 需要的jar包
    1. spring-jdbc
    2. spring-beans
    3. spring-core
    4. spring-tx
    5. spring-jcl


#### Spring JDBC 核心类：JdbcTemplate
1. 构造方法
    1. `public JdbcTemplate(DataSource dataSource)`
2. 执行DDL、DML语句
    1. `int update(String sql,Object... args)`
3. 执行DQL语句
    1. `<T> List<T> query(String sql, RowMapper<T> rowMapper, Object... args)`
    2. `<T> T queryForObject(String sql, RowMapper<T> rowMapper, Object... args)`


