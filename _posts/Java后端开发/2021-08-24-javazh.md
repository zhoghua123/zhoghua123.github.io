---
layout: post
title: 项目实战八-前后端分离驾考项目（七）
category: Java后端开发
tags: Java后端开发
description: Java后端开发
--- 

## 系统模块

### 权限管理
1. 权限管理：对已经**认证成**功的用户进行**授权**
    1. 认证成功：比如使用用户名、密码登录成功
    2. 授权：比如赋值相应的操作权限（资源）
2. 实现方案
    1. 最简单粗暴：用户直接跟资源（权限）挂钩
        1. 设计成3张表：用户表（sys_user)、资源表（sys_resource)、用户资源表（sys_user_resource)
        
            ```
            sys_user
            id      name
            1       jack
            2       rose
            
            sys_resource
            id      name
            1       用户-查询
            2       用户-添加
            3       用户-删除
            
            sys_user_resource
            user_id     resource_id
            1           1
            1           3
            2           2
            2           2
            2           3
            
            ```
        2. 缺点：sys_user_resource表中数据冗余
    2. 建议采用：RBAC(Role-base Access Control)，以角色为基础的访问控制
        1. 用户跟角色挂钩、角色与资源挂钩，设计成5张表
        2. 用户表（sys_user)、角色表（sys_role)、资源（sys_resource)
        3. 用户角色表（sys_user_role）、角色资源表（sys_role_resource）

        ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-47.png) 
        
        
        ```
        sys_user
        id      name
        1       jack
        2       rose
        
        sys_role
        id      name
        1       总经理
        2       销售经理
        3       前台
        
        sys_resource
        id      name
        1       用户-查询
        2       用户-添加
        3       用户-删除
        
        sys_role_resource
        role_id     resource_id
        1           1
        1           2
        1           3
        2           1
        2           3
        3           1
        
        sys_user_role
        user_id     role_id
        1           1
        2           2
        2           3
        ```


### 初始化各个层的类
1. 在EasyCode-MybatisCodeHepler中新增erqVo模板、vo模板
2. 同时选中sys_xxx的5张表，右击，通过EasyCode-MybatisCodeHepler生成对应层的类
3. 简单改造各个层
    1. 删除SysUserRoleController、SysRoleResourceController、SysRoleResourceReqVo、SysUserRoleReqVo
    2. vo/req/save下面的xxxreqvo，添加后台校验的注解字段
        
        ```
        SysResourceReqVo
        SysRoleReqVo
        SysUserReqVo
        ```
    3. vo/list下面的返回值xxxVo
        
        ```
        //资源列表
        SysResourceVo
        //角色列表
        SysRoleVo
        //用户列表
        SysUserVo
        //资源树列表
        //SysResourceTreeVo
        @Data
        public class SysResourceTreeVo {
            private Short id;
            private String title;
            private boolean spread = true;
            private List<SysResourceTreeVo> children;
        }
        ```

### 用户模块

#### 1.列表展示功能
1. vo/req/page下新增模糊查询的的SysUserPageReqVo
    
    ```
    @EqualsAndHashCode(callSuper = true)
    @Data
    public class SysUserPageReqVo extends KeywordPageReqVo {}
    ```
2. SysUserController如下：
    
    ```
    @RestController
    @RequestMapping("/sysUsers")
    public class SysUserController extends BaseController<SysUser, SysUserReqVo> {
        @Autowired
        private SysUserService service;
    
        @Override
        protected IService<SysUser> getService() {
            return service;
        }
        
        //分页查询方法
        @GetMapping
        public PageJsonVo<SysUserVo> list(SysUserPageReqVo reqVo) {
    
            return JsonVos.ok(service.list(reqVo));
        }
    
        @Override
        protected Function<SysUserReqVo, SysUser> getFunction() {
            return MapStructs.INSTANCE::reqVo2po;
        }
    }
    ```
3. service层
    
    ```
    //SysUserService
    public interface SysUserService extends IService<SysUser> {
    PageVo<SysUserVo> list(SysUserPageReqVo reqVo);}
    
    //SysUserServiceImpl
    @Service
    @Transactional
    public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
        @Override
        @Transactional(readOnly = true)
        public PageVo<SysUserVo> list(SysUserPageReqVo reqVo) {
            //1. 单标查询直接使用MpLambdaQueryWrapper
            MpLambdaQueryWrapper<SysUser> wrapper = new MpLambdaQueryWrapper<>();
            wrapper.like(reqVo.getKeyword(),SysUser::getNickname,SysUser::getUsername);
            wrapper.orderByDesc(SysUser::getId);
            //2. 将查询的po类型结果通过po2vo转化为Vo类型
            return baseMapper.selectPage(new MpPage<>(reqVo),wrapper).buildVo(MapStructs.INSTANCE::po2vo);
        }
    }
    ```
4. 运行项目会报错，有以下2个原因
    1. 原因1：MapStructs中没有增加SysUserVo<->SysUser即vo与po之间的转化方式，新增完后，运行项目还会报错
    2. 原因2：po(SysUser)的loginTime属性的类型为：`Date`,Vo(SysUserVo)的loginTime属性类型为`Long`
        1. 注意：时间的返回通常是返回给客户端毫秒的时间戳
    3. 解决办法：
        1. 新增转化格式类：
            
            ```
            //com.zh.jk.common.mapStruct
            public class MapStructFormatter {
                //自定义Date2Millis注解
                //必须添加@Qualifier注解，才能作为属性转化器注解
                @Qualifier
                @Target(ElementType.METHOD)
                @Retention(RetentionPolicy.CLASS)
                public @interface Date2Millis {}
            
                //使用自定义的Date2Millis注解，注解一个方法
                @Date2Millis
                public static Long date2millis(Date date) {
                    if (date == null) return null;
                    //将Date类型转化为毫秒数
                    return date.getTime();
                }
            
                //自定义Mills2Date注解
                //必须添加@Qualifier注解，才能作为属性转化器注解
                @Qualifier
                @Target(ElementType.METHOD)
                @Retention(RetentionPolicy.CLASS)
                public @interface Mills2Date {}
            
                //使用自定义的Mills2Date注解，注释一个转化方法
                @Mills2Date
                public static Date millis2date(Long mills) {
                    if (mills == null) return null;
                    //将毫秒数转化为Date类型
                    return new Date(mills);
                }
            }
            ```
        2. MapStructs中使用
            
            ```
            //com.zh.jk.common.mapStruct
            /**
             * ReqVo -> Po 将客户端传递的ReqVo转化为Vo对象
             * Po -> Vo 通过Mybits-plus到数据库查询的po对象转为Vo对象传递给客户端
             */
            @Mapper(uses = {
                    //指明用哪些格式化器
                    MapStructFormatter.class
            })
            public interface MapStructs {
                MapStructs INSTANCE = Mappers.getMapper(MapStructs.class);
            
                /**po-vo***/
                DictItemVo po2vo(DictItem po);
                DictTypeVo po2vo(DictType po);
                ExamPlaceVo po2vo(ExamPlace po);
                PlateRegionVo po2vo(PlateRegion po);
                ExamPlaceCourseVo po2vo(ExamPlaceCourse po);
                //由于数据库返回的po对象loginTime字段的类型是Date，返回给客户端的Vo对象是Long类型，因此需要做一个转化
                @Mapping(source = "loginTime",
                        target = "loginTime",
                        //通过什么转化：这里必须传递一个自定义的注解，意思是通过MapStructFormatter类中的Date2Millis注解的方法来转化
                        qualifiedBy = MapStructFormatter.Date2Millis.class)
                SysUserVo po2vo(SysUser po);
                SysRoleVo po2vo(SysRole po);
                SysResourceVo po2vo(SysResource po);
            
                /**vo-po***/
                DictItem reqVo2po(DictItemReqVo reqVo);
                DictType reqVo2po(DictTypeReqVo reqVo);
                ExamPlace reqVo2po(ExamPlaceReqVo reqVo);
                PlateRegion reqVo2po(PlateRegionReqVo reqVo);
                ExamPlaceCourse reqVo2po(ExamPlaceCourseReqVo reqVo);
                SysUser reqVo2po(SysUserReqVo reqVo);
                SysRole reqVo2po(SysRoleReqVo reqVo);
                SysResource reqVo2po(SysResourceReqVo reqVo);
            }
            ```
5. 运行项目，列表页面能够正常展示、关键字搜索


### 角色模块

#### 1.列表展示功能
1. vo/req/page下新增模糊查询的的SysRolePageReqVo
    
    ```
    @EqualsAndHashCode(callSuper = true)
    @Data
    public class SysRolePageReqVo extends KeywordPageReqVo {
    }
    ```
2. SysRoleController
    
    ```
    @RestController
    @RequestMapping("/sysRoles")
    public class SysRoleController extends BaseController<SysRole, SysRoleReqVo> {
        @Autowired
        private SysRoleService service;
    
        @Override
        protected IService<SysRole> getService() {
            return service;
        }
        //分页查询方法
        @GetMapping
        public PageJsonVo<SysRoleVo> list(SysRolePageReqVo reqVo) {
    
            return JsonVos.ok(service.list(reqVo));
        }
    
        @Override
        protected Function<SysRoleReqVo, SysRole> getFunction() {
            return MapStructs.INSTANCE::reqVo2po;
        }
    }
    ```
3. service层
    
    ```
    public interface SysRoleService extends IService<SysRole> {
        PageVo<SysRoleVo> list(SysRolePageReqVo reqVo);
    }
    
    @Service
    @Transactional
    public class SysRoleServiceImpl extends ServiceImpl<SysRoleMapper, SysRole> implements SysRoleService {
    
        @Override
        @Transactional(readOnly = true)
        public PageVo<SysRoleVo> list(SysRolePageReqVo reqVo) {
            //1. 单标查询直接使用MpLambdaQueryWrapper
            MpLambdaQueryWrapper<SysRole> wrapper = new MpLambdaQueryWrapper<>();
            wrapper.like(reqVo.getKeyword(),SysRole::getName);
            wrapper.orderByDesc(SysRole::getId);
            //2. 将查询的po类型结果通过po2vo转化为Vo类型
            return baseMapper.selectPage(new MpPage<>(reqVo),wrapper).buildVo(MapStructs.INSTANCE::po2vo);
        }
    }
    ```

### 资源模块

#### 1.列表展示功能
1. vo/req/page下新增模糊查询的的SysResourcePageReqVo
    
    ```
    @EqualsAndHashCode(callSuper = true)
    @Data
    public class SysResourcePageReqVo extends KeywordPageReqVo {
    }
    ```
2. SysResourceController
    
    ```
    @RestController
    @RequestMapping("/sysRoles")
    public class SysResourceController extends BaseController<SysResource, SysResourceReqVo> {
        @Autowired
        private SysResourceService service;
    
        @Override
        protected IService<SysResource> getService() {
            return service;
        }
    
        //分页查询方法
        @GetMapping
        public PageJsonVo<SysResourceVo> list(SysResourcePageReqVo reqVo) {
    
            return JsonVos.ok(service.list(reqVo));
        }
        @Override
        protected Function<SysResourceReqVo, SysResource> getFunction() {
            return MapStructs.INSTANCE::reqVo2po;
        }
    }
    ```
3. service层
    
    ```
    public interface SysResourceService extends IService<SysResource> {
        PageVo<SysResourceVo> list(SysResourcePageReqVo reqVo);
    }
    
    @Service
    @Transactional
    public class SysResourceServiceImpl extends ServiceImpl<SysResourceMapper, SysResource> implements SysResourceService {
    
        @Override
        public PageVo<SysResourceVo> list(SysResourcePageReqVo reqVo) {
            //1. 单标查询直接使用MpLambdaQueryWrapper
            MpLambdaQueryWrapper<SysResource> wrapper = new MpLambdaQueryWrapper<>();
            wrapper.like(reqVo.getKeyword(),SysResource::getName, SysResource::getUri,SysResource::getPermission);
            wrapper.orderByDesc(SysResource::getId);
            //2. 将查询的po类型结果通过po2vo转化为Vo类型
            return baseMapper.selectPage(new MpPage<>(reqVo),wrapper).buildVo(MapStructs.INSTANCE::po2vo);
        }
    }
    ```


