---
layout: post
title: Java常用企业框架-SpringMVC(三)
category: Java后端开发
tags: Java后端开发
description: Java后端开发
--- 

## 特殊的请求参数

### 集合类型
1. index.jsp中的代码
    
    ```
    <form action="tes1t">
        <input name="name">
        <input name="age">
        <div>
            足球<input type="checkbox" value="1" name="hobby">
        </div>
        <div>
            篮球<input type="checkbox" value="2" name="hobby">
        </div>
        <div>
            台球<input type="checkbox" value="3" name="hobby">
        </div>
        <button type="submit">提交</button>
    </form>
    ```
    
    1. 用户名输入123，age输入456，勾选1、3，则请求路径为：`/test1?name=123&age=456&hoppy=1&hoppy=3`
2. Controller的处理函数参数类型为集合类型
    
    ```
    @RequestMapping("/test1")
    @ResponseBody
    //{name=123,age=456,hoppy=1} 1 3
    public String test1(@RequestParam Map<String, Object> map,
//                       String[] hobby,
//                       @RequestParam(required = true) List<String> hobby,
                       @RequestParam(required = false) Set<String> hobby) {
        System.out.println(map);
        for (String s : hobby) {
            System.out.println(s);
        }
        return "success!";
    }
    ```
    
    1. 如果为map打印为：`{name=123,age=456,hoppy=1}`
    2. 如果为map和`String[]`，打印为：`{name=123,age=456,hoppy=1} 1 3`
        1. 注意：数组不需要用`@RequestParam`修饰
    3. 如果为map和`List`，打印为：`{name=123,age=456,hoppy=1} 1 3`
    4. 如果为map和`Set`，打印为：`{name=123,age=456,hoppy=1} 1 3`
3. 即可以将请求参数自动封装成集合进行接收

### multipart参数
1. 添加依赖
    
    ```
    <dependency>
        <groupId>commons-fileupload</groupId>
        <artifactId>commons-fileupload</artifactId>
        <version>1.4</version>
    </dependency>
    ```
2. 添加CommonsMultipartResolver到IoC容器，id值固定为multipartResolver
    
    ```
    //zpplicationContext.xml
    <!-- 解析Multipart参数 -->
    <bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
        <!--保证请求参数，文件名不乱吗-->
        <property name="defaultEncoding" value="UTF-8"/>
        <property name="maxInMemorySize" value="20480"/>
    </bean>
    ```
3. index.jsp：传递multipart类型的参数
    
    ```
    <div>
        <form action="test2" method="post" enctype="multipart/form-data">
            <input name="username">
            <input name="password">
            <button type="submit">提交</button>
        </form>
    </div>
    ```
4. Controller监听服务
    
    ```
    @RequestMapping("/test2")
    @ResponseBody
    public String test2(String username, String password) {
        System.out.println(username);
        System.out.println(password);

        return "test2 success!";
    }
    ```

### 文件上传
1. 前提条件是在【multipart参数】配置的基础上

#### 1.单个文件上传
1. index.jsp
    
    ```
    <div>
        <form action="test3" method="post" enctype="multipart/form-data">
            <input name="username">
            <input type="file" name="photo1">
            <input type="file" name="photo2">
            <button type="submit">提交</button>
        </form>
    </div>
    ```
2. Controller
    
    ```
    @RequestMapping("/test3")
    @ResponseBody
    public String test3(String username,
                        MultipartFile photo1,
                        MultipartFile photo2,
                        HttpServletRequest request) throws Exception {
        System.out.println(username);

        // 将文件数据写入到具体的位置
        //获取文件名称
        String filename = photo1.getOriginalFilename();
        //要写入的文件路径
        String path = request.getServletContext().getRealPath("upload/img/" + filename);
        //创建文件对象
        File file = new File(path);
        //将文件数据写入
        photo1.transferTo(file);

        filename = photo2.getOriginalFilename();
        path = request.getServletContext().getRealPath("upload/img/" + filename);
        file = new File(path);
        photo2.transferTo(file);

        return "test3 success!";
    }
    ```

#### 2.多个文件上传
1. index.jsp
    
    ```
    <div>
        <form action="test4" method="post" enctype="multipart/form-data">
            <input name="username">
            <input type="file" name="photos">
            <input type="file" name="photos">
            <button type="submit">提交</button>
        </form>
    </div>
    ```
2. Controller
    
    ```
    @RequestMapping("/test4")
    @ResponseBody
    //List接收
    //public String test4(String username,List<MultipartFile> photos) throws Exception {
    //数组接收
    public String test4(String username,
                        MultipartFile[] photos) throws Exception {
        System.out.println(username);
        for (MultipartFile photo : photos) {
            System.out.println(photo.getOriginalFilename());
        }
        return "test4 success!";
    }
    ```

#### CommonsMultipartResolver的常用属性
1. defaultEncoding: 设置request的请求编码
2. uploadTempDir: 设置上传文件时的临时目录，默认是Servlet容器的临时目录
3. maxUploadSize:：限制总的上传文件大小，以字节为单位。当设为-1时表示无限制，默认是-1
4. maxUploadSizePerFile:限制每个上传文件的大小
5. maxInMemorySize:设置每个文件上传时允许写到内存中的最大值，以字节为单位，默认是10240
    1. 若一个文件的大小超过这个数值，就会生成临时文件；否则不会生成临时文件
6. 举例
    
    ```
    <!-- 解析Multipart参数 -->
    <bean id="multipartResolver"
          class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
        <!--保证请求参数，文件名不乱吗-->
        <property name="defaultEncoding" value="UTF-8"/>
        <property name="maxInMemorySize" value="20480"/>
    </bean>
    ```
    
### 日期类型
1. Spring(MVC)默认支持yyyy/MM/dd的日期格式转换，其他日期格式需要特殊处理
2. index.jsp
    
    ```
    <div>
        日期处理：
        <form action="test5" method="post">
            <input name="birthday" type="date">
            <button type="submit">提交</button>
        </form>
    </div>
    ```

#### 方法一：使用@DateTimeFormat

```
@RequestMapping("/test5")
@ResponseBody
public String test5(@DateTimeFormat(pattern = "yyyy-MM-dd") Date birthday)
        throws Exception {
    System.out.println(birthday);
    return "test5 success!";
}
```

1. 这种方法有个弊端，每个接收都要设置

#### 方法二：使用Converter
1. 创建DateConverter类
    
    ```
    //com.zh.converter.DateConverter
    public class DateConverter implements Converter<String, Date> {
        @Override
        public Date convert(String source) {
            try {
                return new SimpleDateFormat("yyyy-MM-dd").parse(source);
            } catch (ParseException e) {
                e.printStackTrace();
                return null;
            }
        }
    }
    ```
2. IoC容器配置
    1. 配置conversionService转换器
    
        ```
        <!-- 类型转换器 -->
        <bean id="conversionService" class="org.springframework.context.support.ConversionServiceFactoryBean">
            <property name="converters">
                <set>
                    <bean class="com.zh.converter.DateConverter"/>
                </set>
            </property>
        </bean>
        ```
    2. SpringMVC设置转换器
        
        ```
        <mvc:annotation-driven conversion-service="conversionService">
        ...
        </mvc:annotation-driven>
        ```
3. Controller接收
    
    ```
    @RequestMapping("/test5")
    @ResponseBody
    public String test5(Date birthday)
            throws Exception {
        System.out.println(birthday);
        return "test5 success!";
    }
    ```


