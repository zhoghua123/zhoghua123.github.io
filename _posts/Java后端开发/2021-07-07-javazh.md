---
layout: post
title: Java常用企业框架-Spring(六)
category: Java后端开发
tags: Java后端开发
description: Java后端开发
--- 

## 纯注解开发

### 实现AOP
1. 与之前的注解实现AOP进行比对
2. `@EnableAspectJAutoProxy`相当于`<aop:aspectj-autoproxy/>`
3. 删除applicationContext.xml
4. 新建入口类
    
    ```
    //com.zh.cfg.AppConfig
    @Configuration
    //相当于<aop:aspectj-autoproxy/>
    @EnableAspectJAutoProxy
    @ComponentScan("com.zh")
    public class AppConfig {
    }
    ```
5. 测试入口
    
    ```
    ApplicationContext ctx = new AnnotationConfigApplicationContext(AppConfig.class);
    UserService service = ctx.getBean("userService", UserService.class);
    service.list();
    ```
6. 其余不变

### 实现整合MyBatis
1. 之前示例代码，使用xml整合如下
    
    ```
    <!-- 1. 创建数据源 -->
    <!-- 加载配置文件 -->
    <context:property-placeholder location="db.properties"/>

    <!-- 数据源（Druid） -->
    <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource">
        <property name="driverClassName" value="${jdbc.driverClass}"/>
        <property name="url" value="${jdbc.url}"/>
        <property name="username" value="${jdbc.username}"/>
        <property name="password" value="${jdbc.password}"/>
    </bean>

    <!--2.创建SqlSessionFactoryBean，获取sqlsession
    设置数据源
    设置别名
    设置映射文件位置
     -->
    <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
        <!-- 数据源 -->
        <property name="dataSource" ref="dataSource"/>
        <!-- 这个包底下的类会自动设置别名（一般是领域模型）
            这个包下面所有的别名就是类名
            比如com.zh.domain.Skill;别名是Skill
         -->
        <property name="typeAliasesPackage" value="com.zh.domain"/>
        <!-- 映射文件的位置 -->
        <property name="mapperLocations">
            <array>
                <value>mappers/*.xml</value>
            </array>
        </property>
    </bean>

    <!-- 3. 扫描dao
    设置sqlSessionFactory名字
    告知到哪里去扫描dao
     -->
    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <!-- 设置SqlSessionFactoryBean的id -->
        <property name="sqlSessionFactoryBeanName" value="sqlSessionFactory"/>
        <!-- 设置dao的包 -->
        <property name="basePackage" value="com.zh.dao"/>
    </bean>
    ```
2. 创建入口类MyBatisConfig
    
    ```
    @Configuration
    //加载配置文件
    @PropertySource("db.properties")
    //MapperScan相当于MapperScannerConfigurer
    @MapperScan("${mybatis.mapperScan}")
    public class MyBatisConfig {
        //纯注解注入基本数据类型
        @Value("${jdbc.driverClassName}")
        private String driverClassName;
        @Value("${jdbc.url}")
        private String url;
        @Value("${jdbc.username}")
        private String username;
        @Value("${jdbc.password}")
        private String password;
        @Value("${mybatis.typeAliasesPackage}")
        private String typeAliasesPackage;
        @Value("${mybatis.mapperLocations}")
        private String mapperLocations;
    
        //创建数据源，因为DruidDataSource类是第三方的，所以通过@Bean方法
        @Bean
        public DataSource dataSource() {
            DruidDataSource ds = new DruidDataSource();
            ds.setDriverClassName(driverClassName);
            ds.setUrl(url);
            ds.setUsername(username);
            ds.setPassword(password);
            return ds;
        }
        //创建SqlSessionFactoryBean，获取sqlsession
        @Bean
        public SqlSessionFactoryBean sqlSessionFactory() throws Exception {
            SqlSessionFactoryBean bean = new SqlSessionFactoryBean();
            bean.setDataSource(dataSource());
            //设置别名
            bean.setTypeAliasesPackage(typeAliasesPackage);
            //映射文件的位置
            PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();
            bean.setMapperLocations(resolver.getResources(mapperLocations));
            return bean;
        }
    
        //扫描dao
        //可以直接使用MapperScan来代替
    //    @Bean
    //    public MapperScannerConfigurer configurer() {
    //        MapperScannerConfigurer configurer = new MapperScannerConfigurer();
              //不用手动注入，可以直接通过参数类型自动注入
    //        configurer.setSqlSessionFactoryBeanName("sqlSessionFactory");
              //设置要扫描的dao
    //        configurer.setBasePackage("com.zh.dao");
    //        return configurer;
    //    }
    }
    ```
3. 配置文件内容如下：db.properties
    
    ```
    jdbc.driverClassName=com.mysql.jdbc.Driver
    jdbc.url=jdbc:mysql://localhost:3306/test-mybatis
    jdbc.username=root
    jdbc.password=root
    
    mybatis.typeAliasesPackage=com.zh.domain
    mybatis.mapperLocations=mappers/*.xml
    mybatis.mapperScan=com.zh.dao
    ```
4. SkillTest
    
    ```
    @Before
    public void before() {
        ctx = new AnnotationConfigApplicationContext("com.zh");
        skillDao = ctx.getBean("skillDao", SkillDao.class);
    }

    @Test
    public void list() {
        List<Skill> skills = skillDao.list();
        System.out.println(skills);
    }
    ```

### 实现事务管理
1. 之前xml与半注解实现事务管理如下
    
    ```
    <!-- 上面是整合MyBatis，略 -->
    <!-- 事务管理器 -->
    <bean id="txMgr"
          class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <!--设置注解驱动
    取代之前的<tx:advice>、`<aop:config>
     -->
    <tx:annotation-driven transaction-manager="txMgr"/>
    <!--让spring扫描这个包下所有的类，用来解析注解-->
    <context:component-scan base-package="com.zh"/>

    <!-- 附加代码：事务管理代码 -->
    <!--    <tx:advice id="txAdvice" transaction-manager="txMgr">-->
    <!--        <tx:attributes>-->
    <!--            <tx:method name="*"/>-->
    <!--            <tx:method name="list*" propagation="SUPPORTS"/>-->
    <!--        </tx:attributes>-->
    <!--    </tx:advice>-->

    <!-- 切面 -->
    <!--    <aop:config>-->
    <!--        <aop:pointcut id="pc" expression="within(com.zh.service..*)"/>-->
    <!--        <aop:advisor advice-ref="txAdvice" pointcut-ref="pc"/>-->
    <!--    </aop:config>-->
    ```
2. 现在就是如何使用注解替换上面的xml
3. 创建一个单独的类实现：TxConfig
    
    ```
    @Configuration
    //EnableTransactionManagement相当于<tx:annotation-driven />
    //类型自动注入功能，不需要将事务管理器手动注入
    @EnableTransactionManagement
    public class TxConfig {
        @Bean
        //创建事务管理器
        //dataSource注入：由参数类型自动注入，容器中在mybatis中已经生成该对象
        public DataSourceTransactionManager mgr(DataSource dataSource) {
            DataSourceTransactionManager mgr = new DataSourceTransactionManager();
            mgr.setDataSource(dataSource);
            return mgr;
        }
    }
    ```
4. 测试入口
    
    ```
    private ApplicationContext ctx;
    private SkillService skillService;
    @Before
    public void before() {
        ctx = new AnnotationConfigApplicationContext("com.zh");
        skillService = ctx.getBean("skillService", SkillService.class);
    }
    @Test
    public void save() throws Exception {
        skillService.test(null);
    }
    ```
    



