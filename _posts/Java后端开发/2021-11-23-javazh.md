---
layout: post
title: Java进阶-RocketMQ
category: Java后端开发
tags: Java后端开发
description: Java后端开发
---  

### 消息中间件概述
1. 不同系统之间的数据通信
    1. 方式一：通过RPC请求远程直接调用物流服务（Dubbo、SpringCloud）
    2. 方式二：通过消息中间件（RocketMQ、KafKa、RabbitMQ）完成消息的存储和转发
2. 应用场景
    1. 异步解耦
        1. 在一个庞大的业务系统中, 通过对于主要业务模块和其他业务模块之间进行业务解耦
        2. 可以保障整体系统的稳定性, 比如物流系统在某一个时刻出现故障, 并不会影响用户下单操作
        3. 提高用户下单的响应速度, 比如以前没有消息中间件, 需要400ms的处理时间, 现在引入消息中间件只需要110ms的处理时间
        4. 如下图
            ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-70.png)
            
            1. 如果直接通过RPC通信，那么业务是串行的
                1. 订单服务首先通过RPC访问库存服务，拿到库存数据（100ms）
                2. 然后在去调用物流服务通知物流（100ms）
                3. 然后再去调用积分服务修改积分（100ms）
                4. 整体耗时（创建订单100ms）400ms
            2. 如果使用消息中间件MQ，业务是异步的
                1. 订单服务只需要将获取库存、通知物流、修改积分都直接发送给MQ
                2. 库存服务、物流服务、积分服务自己去到MQ中去消费消息
                3. 任意一个服务挂了，不影响其他服务
                4. 耗时110ms
    2. 削峰填谷
        1. 其中在我们应用系统架构的时候引入了消息中间件MQ之后, 我们所有的用户请求全部先到达消息中间件MQ, 然后业务系统从MQ读取对应的消息进行业务处理
        2. 假设业务系统的处理的峰值是1w/qps, 
            1. 当用户请求的qps在低于一万的时候, 用户的请求可以正常的处理
            2. 当用户请求在某一个时刻突然高于1w/qps的时候, 比如在达到3w/qps的时候, 对于业务系统则可以达到自己的处理封装1w/qps, 消息中间件则可以达到3w/qps,这个时候会有很多的消息在消息中间件堆积,等待业务系统处理，这时消息中间件起到一个削峰的作用
            3. 当业务系统相对来说比较空闲的时候, 用户的请求低于1w/qps的时候,那么对于mq的处理能力是和用户处理能力一样, 但是对于应用系统可能还是在维持一个峰值(1w/qps)进行业务处理, 这是消息中间件起到一个填谷的作用 
        3. 下图
    
            ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-71.png)
    3. 消息分发
        1. 在双十一, 618这种大促销活动, 商家的同一件商品可能会有很多的分会场（天猫、京东等）,对于价格的一个变化需要及时的通知到分会场
        2. 如果使用数据库，一个价格更新后直接修改数据，其他分会场直接去访问数据库，此时数据库并发量比较大，导致页面响应缓慢；而且其他分会场并不知道数据库何时更新的数据，不能及时更新。
        3. 可以通过MQ构建分布式缓存, 及时的通知到分会场商品数据的变化
            1. 数据实时更新
            2. 降低页面响应时间
            3. 满足大规模的数据访问

            ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-72.png)
3. 常见的消息中间件
    1. 对于消息中间件最关心的两个指标
        1. 高吞吐
        2. 低延迟
    2. 所谓高吞吐, 指的是并发处理能力非常好,比如单机情况下, KafKa可以达到百万级的处理能力, RocketMQ可以达到十万级的处理能力
    3. 所谓低延迟, 指的是对于请求处理的响应时间, 比如RocketMQ可以做到1ms内响应的延迟超过99.6%
    4. 常见的消息中间件
        1. ActiveMQ
            1. ActiveMQ是Apache出品,比较老的一个开源的消息中间件, 是一个完全支持JMS规范的消息中间件.
            2. API丰富,以前在中小企业应用广泛，现在比较少企业使用
        2. RabbitMQ
            1. RabbitMQ是实现了高级消息队列协议（AMQP）的开源消息代理软件（亦称面向消息的中间件）。RabbitMQ服务器是用Erlang语言编写的，而集群和故障转移是构建在开放电信平台框架上的。所有主要的编程语言均有与代理接口通讯的客户端库。
        3. KafKa
            1. Kafka是由Apache软件基金会开发的一个开源流处理平台，由Scala和Java编写。Kafka是一种高吞吐量的分布式发布订阅消息系统，它可以处理消费者在网站中的所有动作流数据。
            2. 在大数据领域和日志处理解决方案用的比较多
        4. RocketMQ
            1. RocketMQ 是阿里巴巴在 2012 年开源的分布式消息中间件，目前已经捐赠给 Apache 软件基金会，并于 2017 年 9 月 25 日成为 Apache 的顶级项目。作为经历过多次阿里巴巴双十一这种“超级工程”的洗礼并有稳定出色表现的国产中间件，以其高性能、低延时和高可靠等特性近年来已经也被越来越多的国内企业使用。
            2. 淘宝内部的交易系统使用了淘宝自主研发的 Notify 消息中间件，使用 MySQL 作为消息存储媒介，可完全水平扩容，为了进一步降低成本，我们认为存储部分可以进一步优化，2011 年初，Linkin开源了 Kafka 这个优秀的消息中间件，淘宝中间件团队在对 Kafka 做过充分 Review 之后， Kafka 无限消息堆积，高效的持久化速度吸引了我们，但是同时发现这个消息系统主要定位于日志传输，对于使用在淘宝交易、订单、充值等场景下还有诸多特性不满足，为此我们重新用 Java 语言编写了 RocketMQ ，定位于非日志的可靠消息传输（日志场景也OK），目前 RocketMQ 在阿里集团被广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理， binlog 分发等场景。
        5. 消息中间件对比
            
            ![图1](https://gitee.com/zhonghua123/blogimgs/raw/master/img/javazh-73.png)


### RocketMQ的核心特性
1. 低延迟
    1. 1ms内响应的延迟超过99.6%，就是在1ms内响应超过99.6%
2. 高稳定性
    1. 阿里巴巴双十一官方指定消息产品，支撑阿里巴巴集团所有的消息服务，历经十余年高可用与高可靠的严苛考验，是阿里巴巴交易链路的核心产品；
    2. 服务可用性 99.95%，Region 化、多可用区、分布式集群化部署，确保服务高可用，即便整个机房不可用仍可正常提供消息服务；
    3. 数据可靠性 99.99999999%，同步双写、超三副本数据冗余与快速切换技术确保数据可靠；
3. 高性能
    1. 历年双 11 购物狂欢节零点千万级 TPS、万亿级数据洪峰，创造了全球最大的业务消息并发以及流转纪录（日志类消息除外）；
    2. 在始终保证高性能前提下，支持亿级消息堆积，不影响集群的正常服务，在削峰填谷（蓄洪）、微服务解耦的场景下尤为重要；
4. 丰富的消息类型
    1. 提供丰富的消息类型，满足各种严苛场景下的高级特性需求，当前支持的消息类型涵盖普通消息、顺序消息（全局顺序 / 分区顺序）、分布式事务消息、定时消息/延时消息；

### RocketMQ的核心组件
1. 运行模型（**重点！！！**）
    1. 启动服务器NameServer,NameServer的作用类似于ZK这样的注册中心, 主要用于存储元数据的管理, 比如每个Topic的位置信息 
    2. 启动服务器Broker, Broker是数据处理服务器,对于不同的消息, 存储在不同的Topic中, 在同一个Topic, 为了提高消息处理的并发能力, 一个Topic会有多个Queue队列
    3. 启动生产者, 连接NameServer, 获取对应的Topic信息, 开始创建消息并发送
    4. 启动消费者, 连接NameServer, 获取对应的Topic信息, 开始消费消息

