---
layout: post
title: iOS底层-内存管理(二)
category: iOS底层
tags: iOS底层
description: iOS底层
---  

## 内存布局

### Tagged Pointer
1. 从64bit开始，iOS引入了`Tagged Pointer`技术，用于优化NSNumber、NSDate、NSString等小对象的存储
2. 在没有使用`Tagged Pointer`之前， NSNumber等对象需要动态分配内存、维护引用计数等，`NSNumber`指针存储的是堆中`NSNumber`对象的地址值
3. 使用`Tagged Pointer`之后，`NSNumber`指针里面存储的数据变成了：`Tag + Data`，也就是将数据直接存储在了指针中(Tag指的是数据类型)
    1. 即用指针类型(8个字节)存储`Tag+Data`
4. 当指针不够存储数据时，才会使用动态分配内存的方式来存储数据
5. `objc_msgSend`能识别`Tagged Pointer`，比如NSNumber的`intValue`方法，直接从指针提取数据，节省了以前的调用开销
6. 如何判断一个指针是否为`Tagged Pointer`？
    1. iOS平台，最高有效位是1（第64bit）
    2. Mac平台，最低有效位是1
    3. objc源码证明：
        
        ```
        
        ```
7. 下面代码例证：
    
    1. 例1：
        
        ```
        int main(int argc, char * argv[])
        {
            @autoreleasepool {
                NSNumber *number1 = @1;
                NSNumber *number2 = @2;
                NSNumber *number3 = @3;
                NSNumber *numberFFFF = @(0xFFFF);
                
                NSLog(@"number1 pointer is %p", number1);
                NSLog(@"number2 pointer is %p", number2);
                NSLog(@"number3 pointer is %p", number3);
                NSLog(@"numberffff pointer is %p", numberFFFF);
                return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));
            }
        }
        
        //打印
        number1 pointer is 0xb000000000000012
        number2 pointer is 0xb000000000000022
        number3 pointer is 0xb000000000000032
        numberFFFF pointer is 0xb0000000000ffff2
        ```
    2. 例2:
        ```
        /**
         会崩溃
         因为self.name的本质是掉用set方法
         -(void)setName:(NSString *)name{
         if (name != _name) {
         //n个线程同时访问，就会一个对象多次释放，崩溃
         [_name release];
         _name = [name copy];
         }
         }
        */
        dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
        for (int i = 0; i<1000; i++) {
            dispatch_async(queue, ^{
                //会崩溃
                //self.name = [NSString stringWithFormat:@"abcdefghijk"];
                //不会崩溃,是Tagged Pointer不是oc对象，因此不会调用set方法
                self.name = [NSString stringWithFormat:@"abc"];
            });
        }
        ```

