---
layout: post
title: iOS底层-Runtime系列二
category: iOS底层
tags: iOS底层
description: iOS底层
--- 

## Class的结构

### 获取源码
1. 查看源码

    ```
    typedef struct objc_class *Class;
    ```
2. Class是objc_class结构体指针
    
    ```
    struct objc_class : objc_object {
        ....
    }
    ```
3. objc_class继承自objc_object
    
    ```
    struct objc_object {
    private:
        isa_t isa;
    ...    
    }
    ```
4. 将父类也整合到objc_class类中如下：（注意这里只考虑成员变量）
    
    ```
    struct objc_class  {
    // Class ISA;
    private:
        isa_t isa;
    public:
        Class superclass;
        cache_t cache;             // formerly cache pointer and vtable
        class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags
        
        //这个成员函数是特殊。使用bits成员的data()函数可以获取class_rw_t*
        class_rw_t *data() { 
            return bits.data();
        ....成员函数
    }
    ```
5. `class_rw_t `如下：
    
    ```
    struct class_rw_t {
        uint32_t flags;
        uint32_t version;
        const class_ro_t *ro; //其他信息
        method_array_t methods;//方法列表
        property_array_t properties; //属性列表
        protocol_array_t protocols; //协议列表
        Class firstSubclass;
        Class nextSiblingClass;
        char *demangledName;
        ...成员函数
    }
    ```
6. `class_ro_t`如下
    
    ```
    struct class_ro_t {
        uint32_t flags;
        uint32_t instanceStart;
        uint32_t instanceSize;
    #ifdef __LP64__
        uint32_t reserved;
    #endif
        const uint8_t * ivarLayout;
        const char * name;//类名
        method_list_t * baseMethodList;
        protocol_list_t * baseProtocols;
        const ivar_list_t * ivars;//成员变量列表
    
        const uint8_t * weakIvarLayout;
        property_list_t *baseProperties;
    };
    ```
7. 分析：
    1. class_rw_t里面的methods、properties、protocols是二维数组，是可读可写的，包含了类的初始内容、分类的内容
    2. class_ro_t里面的baseMethodList、baseProtocols、ivars、baseProperties是一维数组，是只读的，包含了类的初始内容  
    


